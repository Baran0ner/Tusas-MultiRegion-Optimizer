<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TUSAÅ | Laminate Stacking Optimizer</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/static/css/app.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
              mono: ['JetBrains Mono', 'ui-monospace', 'SFMono-Regular'],
            },
            colors: {
              space: {
                900: '#0f172a',
                800: '#111827',
                700: '#1f2937',
              },
              /* Aerospace Blue (kurumsal) */
              electric: '#1d4ed8',
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-transparent text-slate-900 font-sans min-h-screen antialiased">
    <div class="min-h-screen flex">
      <!-- Sidebar -->
      <aside class="w-80 bg-gradient-to-b from-slate-950 via-slate-900 to-slate-800 border-r border-slate-900/40 p-6 flex flex-col gap-6">
        <div>
          <p class="text-xs uppercase tracking-[0.28em] text-slate-400">Control Panel</p>
          <h1 class="text-xl font-semibold mt-1 text-white">Laminate Inputs</h1>
          <p class="text-sm text-slate-300 mt-2">Root (thickest) zone iÃ§in ply sayÄ±larÄ±.</p>
        </div>
        <form id="optimize-form" class="flex flex-col gap-4">
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm text-slate-200 font-medium">
              0Â°
              <input
                type="number"
                name="0"
                value="18"
                min="0"
                class="mt-1 w-full bg-white/90 border border-slate-300/70 rounded-md px-3 py-2 text-sm text-slate-900 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </label>
            <label class="text-sm text-slate-200 font-medium">
              90Â°
              <input
                type="number"
                name="90"
                value="18"
                min="0"
                class="mt-1 w-full bg-white/90 border border-slate-300/70 rounded-md px-3 py-2 text-sm text-slate-900 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </label>
            <label class="text-sm text-slate-200 font-medium">
              +45Â°
              <input
                type="number"
                name="45"
                value="18"
                min="0"
                class="mt-1 w-full bg-white/90 border border-slate-300/70 rounded-md px-3 py-2 text-sm text-slate-900 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </label>
            <label class="text-sm text-slate-200 font-medium">
              -45Â°
              <input
                type="number"
                name="-45"
                value="18"
                min="0"
                class="mt-1 w-full bg-white/90 border border-slate-300/70 rounded-md px-3 py-2 text-sm text-slate-900 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </label>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm text-slate-200 font-medium">
              Population
              <input
                type="number"
                name="population_size"
                value="120"
                min="30"
                class="mt-1 w-full bg-white/90 border border-slate-300/70 rounded-md px-3 py-2 text-sm text-slate-900 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </label>
            <label class="text-sm text-slate-200 font-medium">
              Generations
              <input
                type="number"
                name="generations"
                value="600"
                min="50"
                class="mt-1 w-full bg-white/90 border border-slate-300/70 rounded-md px-3 py-2 text-sm text-slate-900 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </label>
          </div>

          <div class="pt-2">
            <button
              type="submit"
              class="w-full button-with-icon btn-blue btn-anim"
            >
              <svg
                class="icon"
                viewBox="0 0 48 48"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path
                  fill="#ffffff"
                  d="M12 39c-.549 0-1.095-.15-1.578-.447A3.008 3.008 0 0 1 9 36V12c0-1.041.54-2.007 1.422-2.553a3.014 3.014 0 0 1 2.919-.132l24 12a3.003 3.003 0 0 1 0 5.37l-24 12c-.42.21-.885.315-1.341.315z"
                ></path>
              </svg>
              <span class="text">Start Optimization</span>
            </button>
          </div>
        </form>
        <!-- TasarÄ±m Modu (ÅŸimdilik kaldÄ±rÄ±ldÄ±) -->
      </aside>

      <!-- Main Content -->
      <main class="flex-1 p-8 relative overflow-hidden bg-transparent">
        <div id="loading-overlay" class="hidden absolute inset-0 bg-slate-900/20 backdrop-blur-sm flex flex-col items-center justify-center z-20">
          <div class="bg-white/90 border border-slate-300/60 rounded-xl p-8 max-w-md w-full shadow-xl backdrop-blur">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
              <div>
                <p class="text-sm font-semibold text-slate-900">Optimization in Progress</p>
                <p class="text-xs text-slate-600" id="loading-status">Initializing...</p>
              </div>
            </div>
            
            <div class="space-y-2">
              <div class="flex items-center gap-2 text-xs">
                <div id="rule-1-icon" class="w-4 h-4 flex items-center justify-center">â³</div>
                <span class="text-slate-700">Rule 1: Checking Symmetry...</span>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <div id="rule-2-icon" class="w-4 h-4 flex items-center justify-center">â³</div>
                <span class="text-slate-700">Rule 2: Validating Balance...</span>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <div id="rule-3-icon" class="w-4 h-4 flex items-center justify-center">â³</div>
                <span class="text-slate-700">Rule 3: Checking Adjacency...</span>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <div id="rule-4-icon" class="w-4 h-4 flex items-center justify-center">â³</div>
                <span class="text-slate-700">Rule 4: Checking External Plies...</span>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <div id="rule-5-icon" class="w-4 h-4 flex items-center justify-center">â³</div>
                <span class="text-slate-700">Rule 5: Analyzing Distribution...</span>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <div id="rule-6-icon" class="w-4 h-4 flex items-center justify-center">â³</div>
                <span class="text-slate-700">Rule 6: Checking Grouping...</span>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <div id="rule-7-icon" class="w-4 h-4 flex items-center justify-center">â³</div>
                <span class="text-slate-700">Rule 7: Evaluating Buckling...</span>
              </div>
              <div class="flex items-center gap-2 text-xs">
                <div id="rule-8-icon" class="w-4 h-4 flex items-center justify-center">â³</div>
                <span class="text-slate-700">Rule 8: Checking Lateral Bending...</span>
              </div>
            </div>
            
            <div class="mt-6 pt-4 border-t border-slate-200">
              <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden border border-slate-200">
                <div id="loading-progress" class="h-full bg-blue-600 transition-all duration-300" style="width: 0%"></div>
              </div>
              <p class="text-xs text-slate-600 mt-2 text-center" id="loading-progress-text">0%</p>
            </div>
          </div>
        </div>

        <div class="flex items-center justify-between mb-6">
          <div>
            <p class="text-xs uppercase tracking-[0.28em] text-slate-500">Mission Control</p>
            <h2 class="text-2xl font-semibold text-slate-900">Laminate Stacking Dashboard</h2>
          </div>
          <div class="text-right text-sm text-slate-600 font-mono" id="run-meta">Ready</div>
        </div>

        <div id="empty-state" class="h-[70vh] bg-white/70 backdrop-blur border-2 border-dashed border-slate-300/70 rounded-xl flex flex-col items-center justify-center text-slate-700 shadow-sm">
          <div class="text-lg font-semibold text-slate-900">Ready for Simulation</div>
          <p class="text-sm text-slate-600 mt-2">Input ply counts and launch the optimizer to visualize results.</p>
        </div>

        <div id="results" class="hidden space-y-6 animate-[fadeIn_0.6s_ease]">
          <!-- Metric Cards -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="col-span-2 bg-white/70 backdrop-blur border border-slate-300/60 rounded-xl p-4 shadow-sm">
              <p class="text-xs uppercase tracking-wide text-slate-600">Fitness Score</p>
              <div class="flex items-baseline gap-2 mt-2">
                <span id="fitness-score" class="text-3xl font-bold text-slate-900">--</span>
                <span class="text-xs text-slate-500">/100</span>
              </div>
              <div id="stats-meta" class="text-xs text-slate-600 mt-2"></div>
              <div id="fitness-hint" class="text-xs text-slate-600 mt-3 pt-3 border-t border-slate-200">
                <span class="text-slate-500">ğŸ’¡</span> 100'den tÃ¼m cezalarÄ±n Ã§Ä±karÄ±lmasÄ±yla hesaplanÄ±r. YÃ¼ksek skor = kurallara uygun dizilim.
              </div>
            </div>
            <div class="bg-white/70 backdrop-blur border border-slate-300/60 rounded-xl p-4 shadow-sm">
              <p class="text-xs uppercase tracking-wide text-slate-600">Symmetry Score</p>
              <div id="symmetry-penalty" class="text-2xl font-mono mt-2 text-emerald-700">-- / 100</div>
              <div id="symmetry-hint" class="text-xs text-slate-600 mt-3 pt-3 border-t border-slate-200">
                <span class="text-slate-500">ğŸ’¡</span> Ä°lk ve son katmanlarÄ±n simetrik eÅŸleÅŸmesi kontrol edilir. 100 = mÃ¼kemmel simetri.
              </div>
            </div>
            <div class="bg-white/70 backdrop-blur border border-slate-300/60 rounded-xl p-4 shadow-sm">
              <p class="text-xs uppercase tracking-wide text-slate-600">Balance Score</p>
              <div id="balance-score" class="text-2xl font-mono mt-2 text-emerald-700">-- / 100</div>
              <div id="balance-hint" class="text-xs text-slate-600 mt-3 pt-3 border-t border-slate-200">
                <span class="text-slate-500">ğŸ’¡</span> +45Â° ve -45Â° katmanlarÄ±nÄ±n sayÄ±sal dengesi. 100 = dengeli daÄŸÄ±lÄ±m.
              </div>
            </div>
          </div>

          <!-- Penalty Breakdown + KurallarÄ±n AmacÄ± (eÅŸ boyut / kompakt) -->
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 items-stretch">
            <div class="bg-white/70 backdrop-blur border border-slate-300/60 rounded-xl p-3 shadow-sm flex flex-col min-h-[560px] max-h-[70vh]">
              <div>
                <p class="text-sm font-semibold text-slate-900">Penalty Breakdown</p>
                <p class="text-xs text-slate-600 mt-1">Ceza puanlarÄ± ve gerekÃ§eleri (Ã¶rn. simetri bozulmasÄ±, aÅŸÄ±rÄ± grup, dÄ±ÅŸ katmanda 45Â° eksikliÄŸi).</p>
              </div>
              <div id="penalty-list" class="mt-3 space-y-2 text-sm flex-1 min-h-0 overflow-y-auto pr-1"></div>
          </div>

            <div class="bg-white/70 backdrop-blur border border-slate-300/60 rounded-xl p-3 shadow-sm flex flex-col min-h-[560px] max-h-[70vh]">
              <div>
                <p class="text-xs uppercase tracking-wide text-slate-600">KurallarÄ±n AmacÄ±</p>
                <p class="text-sm text-slate-600">Her kuralÄ±n â€œne iÅŸe yaradÄ±ÄŸÄ±â€ (mÃ¼hendislik gerekÃ§esi).</p>
              </div>

              <div class="mt-3 space-y-2 text-sm flex-1 min-h-0 overflow-y-auto pr-1">
                <div class="bg-slate-50/70 border border-slate-200 rounded-lg p-2">
                  <div class="font-semibold text-slate-900">R1 â€” Symmetry (Simetri)</div>
                  <div class="text-slate-700 mt-1 text-xs leading-relaxed">Ä°Ã§ gerilmeleri dengeler, eÄŸilme/Ã§arpÄ±lma riskini azaltÄ±r ve Ã¼retim sonrasÄ± stabiliteyi artÄ±rÄ±r.</div>
            </div>
                <div class="bg-slate-50/70 border border-slate-200 rounded-lg p-2">
                  <div class="font-semibold text-slate-900">R2 â€” Balance (Denge)</div>
                  <div class="text-slate-700 mt-1 text-xs leading-relaxed">+45Â° ve âˆ’45Â° dengesini saÄŸlayarak kuplaj (twist/bend coupling) etkilerini ve istenmeyen burulmayÄ± azaltÄ±r.</div>
              </div>
                <div class="bg-slate-50/70 border border-slate-200 rounded-lg p-2">
                  <div class="font-semibold text-slate-900">R3 â€” Percentage / Adjacency (YÃ¼zde & KomÅŸuluk)</div>
                  <div class="text-slate-700 mt-1 text-xs leading-relaxed">AÃ§Ä± yÃ¼zdeleriyle rijitlik/taÅŸÄ±ma dengesi kurar; komÅŸuluk kontrolÃ¼yle ani yÃ¶n deÄŸiÅŸimlerini azaltÄ±p hasar dayanÄ±mÄ±nÄ± iyileÅŸtirir.</div>
              </div>
                <div class="bg-slate-50/70 border border-slate-200 rounded-lg p-2">
                  <div class="font-semibold text-slate-900">R4 â€” External Plies (DÄ±ÅŸ Katmanlar)</div>
                  <div class="text-slate-700 mt-1 text-xs leading-relaxed">YÃ¼zeyde uygun aÃ§Ä± seÃ§imiyle darbe/hasar toleransÄ± artar ve dÄ±ÅŸ kabukta daha gÃ¼venli bir â€œskinâ€ davranÄ±ÅŸÄ± saÄŸlanÄ±r.</div>
              </div>
                <div class="bg-slate-50/70 border border-slate-200 rounded-lg p-2">
                  <div class="font-semibold text-slate-900">R5 â€” Distribution (DaÄŸÄ±lÄ±m)</div>
                  <div class="text-slate-700 mt-1 text-xs leading-relaxed">AÃ§Ä±larÄ± laminat boyunca homojen daÄŸÄ±tarak lokal zayÄ±flÄ±klarÄ± ve performans dalgalanmalarÄ±nÄ± azaltÄ±r.</div>
            </div>
                <div class="bg-slate-50/70 border border-slate-200 rounded-lg p-2">
                  <div class="font-semibold text-slate-900">R6 â€” Grouping / Contiguity (Gruplama)</div>
                  <div class="text-slate-700 mt-1 text-xs leading-relaxed">AynÄ± aÃ§Ä±dan Ã§ok sayÄ±da katmanÄ± yan yana getirmeyerek delaminasyon, Ã§atlak ilerlemesi ve Ã¼retim risklerini dÃ¼ÅŸÃ¼rÃ¼r.</div>
                </div>
                <div class="bg-slate-50/70 border border-slate-200 rounded-lg p-2">
                  <div class="font-semibold text-slate-900">R7 â€” Buckling (Burkulma)</div>
                  <div class="text-slate-700 mt-1 text-xs leading-relaxed">UÃ§/ince bÃ¶lgelerde Â±45Â° katkÄ±sÄ± ile burkulma davranÄ±ÅŸÄ±nÄ± iyileÅŸtirir; Ã¶zellikle yÃ¼k transferi ve stabilite iÃ§in kritiktir.</div>
                </div>
                <div class="bg-slate-50/70 border border-slate-200 rounded-lg p-2">
                  <div class="font-semibold text-slate-900">R8 â€” Lateral Bending (Lateral EÄŸilme)</div>
                  <div class="text-slate-700 mt-1 text-xs leading-relaxed">90Â° katmanlarÄ±n konumu ile lateral eÄŸilme rijitliÄŸi yÃ¶netilir; katmanlarÄ±n orta dÃ¼zleme yakÄ±nlÄ±ÄŸÄ±/uzaklÄ±ÄŸÄ± performansÄ± etkiler.</div>
                </div>
              </div>
            </div>
          </div>

          <!-- JS compatibility: Hesaplama Ã¶zeti elemanlarÄ± artÄ±k UIâ€™de yok, ama IDâ€™ler gizli tutulur -->
          <div class="hidden" aria-hidden="true">
            <div id="summary-runtime">--</div>
            <div id="summary-params">--</div>
            <div id="summary-master">--</div>
            <div id="summary-dropoff">--</div>
          </div>

          <!-- Laminate Map -->
          <div class="bg-white/70 backdrop-blur border border-slate-300/60 rounded-xl p-4 shadow-sm">
            <div class="flex items-center justify-between mb-4">
              <div>
              <p class="text-sm font-semibold text-slate-900">Laminate Map (Drop-Off)</p>
                <p class="text-xs text-slate-600 mt-1">KatmanlarÄ± sÃ¼rÃ¼kle-bÄ±rak ile taÅŸÄ±yabilirsiniz</p>
              </div>
              <div class="flex gap-2 text-xs text-slate-600 items-center">
                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-emerald-500 inline-block"></span>0Â°</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-sky-500 inline-block"></span>90Â°</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-rose-500 inline-block"></span>+45Â°</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 bg-amber-500 inline-block"></span>-45Â°</span>
                <span class="flex items-center gap-1 ml-2 border-l border-slate-200 pl-2"><span class="w-[3px] h-4 bg-amber-500 inline-block shadow-[0_0_6px_rgba(245,158,11,0.35)]"></span>Simetri Ekseni</span>
              </div>
            </div>
            <div id="laminate-map" class="mt-4 flex flex-col gap-3"></div>
            
            <!-- Zone Management Panel -->
            <div id="zone-management-section" class="mt-6 pt-6 border-t border-slate-200 hidden">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-slate-900">Zone YÃ¶netimi (Åematik TasarÄ±m)</h3>
                <button
                  id="init-root-zone-btn"
                  class="button-with-icon btn-slate"
                >
                  <span class="text">Root Zone'u BaÅŸlat</span>
                </button>
              </div>
              
              <!-- Zone Diagram -->
              <div id="zone-diagram" class="bg-slate-200/30 border border-slate-300/60 rounded-lg p-6 mb-4 min-h-[400px] shadow-sm backdrop-blur">
                <div class="text-slate-500 text-center py-20">
                  Zone diyagramÄ± burada gÃ¶rÃ¼ntÃ¼lenecek
                </div>
              </div>
              
              <!-- Zone BirleÅŸtir -->
              <div class="bg-white/70 backdrop-blur border border-slate-300/60 rounded-lg p-4 shadow-sm mb-4">
                <h4 class="text-sm font-semibold text-slate-800 mb-3">Zone BirleÅŸtir</h4>
                <div class="space-y-3">
                  <div>
                    <label class="text-xs text-slate-600 block mb-1">BirleÅŸtirilecek Zone'lar (Ã‡oklu SeÃ§im)</label>
                    <select id="merge-zones-select" multiple class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 min-h-[80px] focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                      <option value="">Zone seÃ§iniz...</option>
                    </select>
                    <button
                      id="create-zone-merge-btn"
                      class="w-full button-with-icon btn-purple"
                    >
                      <span class="text">BirleÅŸtirme ile Zone OluÅŸtur</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- zone-list ID'si JS iÃ§in gerekli; UI'de gizli tutuyoruz -->
              <div id="zone-list" class="hidden"></div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-slate-200 space-y-4">
              <!-- Drop-Off Input Section -->
              <div class="bg-white/70 backdrop-blur border border-slate-300/60 rounded-lg p-4 space-y-4 shadow-sm">
                <!-- Mevcut Ply SayÄ±sÄ± (gizli referans iÃ§in) -->
                <span id="current-ply-count" class="hidden">--</span>
                
                <!-- AÃ§Ä±ya Ã–zel Drop-Off -->
                <div>
                  <label class="text-sm text-slate-800 font-semibold block mb-3">
                    Drop-Off: AÃ§Ä±ya Ã–zel Hedef SayÄ±larÄ±
                    <span class="text-xs text-slate-500 ml-2">(Her aÃ§Ä±dan kaÃ§ katman kalsÄ±n?)</span>
                    </label>

                  <div class="mb-3">
                    <label class="text-xs text-slate-600 block mb-1">Kaynak Zone</label>
                    <select
                      id="dropoff-source-zone-select"
                      class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    >
                      <option value="master">Mevcut Master (Optimizasyon Sonucu)</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">
                      ğŸ’¡ Zone seÃ§erseniz drop-off o zoneâ€™dan yapÄ±lÄ±r ve sonuÃ§ otomatik ÅŸemaya eklenir.
                    </p>

                    <!-- Plan-view schematic (auto layout, photo-like) -->
                    <div class="mt-3">
                      <div class="flex items-center justify-between">
                        <div class="text-xs font-semibold text-slate-700">Åematik (Toplam Ply)</div>
                        <div class="text-[11px] text-slate-500">Zoneâ€™a tÄ±kla â†’ kaynak seÃ§</div>
                      </div>
                      <div id="plan-schematic" class="mt-2 h-[200px] bg-white/40 border border-slate-300/60 rounded-lg overflow-hidden relative"></div>
                    </div>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-3 mb-3">
                    <label class="text-xs text-slate-700 font-medium">
                      0Â° Hedef
                      <input
                        type="number"
                        id="dropoff-angle-0"
                        min="0"
                        class="mt-1 w-full bg-white border border-slate-300 rounded-md px-2 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Ã–rn: 12"
                      />
                    </label>
                    <label class="text-xs text-slate-700 font-medium">
                      90Â° Hedef
                      <input
                        type="number"
                        id="dropoff-angle-90"
                        min="0"
                        class="mt-1 w-full bg-white border border-slate-300 rounded-md px-2 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Ã–rn: 14"
                      />
                    </label>
                    <label class="text-xs text-slate-700 font-medium">
                      +45Â° Hedef
                      <input
                        type="number"
                        id="dropoff-angle-45"
                        min="0"
                        class="mt-1 w-full bg-white border border-slate-300 rounded-md px-2 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Ã–rn: 16"
                      />
                    </label>
                    <label class="text-xs text-slate-700 font-medium">
                      -45Â° Hedef
                      <input
                        type="number"
                        id="dropoff-angle-m45"
                        min="0"
                        class="mt-1 w-full bg-white border border-slate-300 rounded-md px-2 py-2 text-sm text-slate-900 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Ã–rn: 14"
                      />
                    </label>
                  </div>
                  
                      <button
                    id="apply-dropoff-angle-btn"
                    class="w-full button-with-icon btn-red disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                    <span class="text">AÃ§Ä±ya Ã–zel Drop-Off Uygula</span>
                      </button>
                  
                  <p class="text-xs text-slate-600 mt-2">
                    ğŸ’¡ Her aÃ§Ä±dan belirtilen sayÄ±da katman kalacak ÅŸekilde drop yapÄ±lÄ±r. Master sequence'in pattern'i korunur.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // API base URL: localhost'ta Ã§alÄ±ÅŸÄ±rken relative, Netlify'da gerÃ§ek backend URL'si
      const API_BASE =
        window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
          ? ''
          : 'https://YOUR-BACKEND-DOMAIN.COM'; // TODO: Buraya Flask backend'ini deploy ettiÄŸin URL'i yaz

      const form = document.getElementById('optimize-form');
      const loadingOverlay = document.getElementById('loading-overlay');
      const loadingStatus = document.getElementById('loading-status');
      const loadingProgress = document.getElementById('loading-progress');
      const loadingProgressText = document.getElementById('loading-progress-text');
      const emptyState = document.getElementById('empty-state');
      const resultsSection = document.getElementById('results');
      const fitnessScoreEl = document.getElementById('fitness-score');
      const symmetryPenaltyEl = document.getElementById('symmetry-penalty');
      const balanceScoreEl = document.getElementById('balance-score');
      const fitnessHintEl = document.getElementById('fitness-hint');
      const symmetryHintEl = document.getElementById('symmetry-hint');
      const balanceHintEl = document.getElementById('balance-hint');
      const penaltyListEl = document.getElementById('penalty-list');
      const statsMetaEl = document.getElementById('stats-meta');
      const runMetaEl = document.getElementById('run-meta');
      const laminateMapEl = document.getElementById('laminate-map');
      const summaryParamsEl = document.getElementById('summary-params');
      const summaryMasterEl = document.getElementById('summary-master');
      const summaryDropEl = document.getElementById('summary-dropoff');
      const summaryRuntimeEl = document.getElementById('summary-runtime');
      const dropoffTargetInput = document.getElementById('dropoff-target-input');
      const applyDropoffBtn = document.getElementById('apply-dropoff-btn');
      const currentPlyCountEl = document.getElementById('current-ply-count');
      let chartInstance = null;
      let progressInterval = null;
      let currentMasterSequence = null;
      let originalMasterSequence = null; // Ä°lk optimizasyondan gelen master sequence (drop-off'lar iÃ§in referans)
      let currentPlyCounts = null;
      let dropOffResults = []; // Drop-off sonuÃ§larÄ±nÄ± sakla

      // Kural ikonlarÄ±nÄ± gÃ¼ncelleyen fonksiyon
      function updateRuleStatus(ruleNum, status) {
        const icon = document.getElementById(`rule-${ruleNum}-icon`);
        if (!icon) return;
        
        if (status === 'checking') {
          icon.textContent = 'â³';
          icon.className = 'w-4 h-4 flex items-center justify-center animate-pulse';
        } else if (status === 'done') {
          icon.textContent = 'âœ…';
          icon.className = 'w-4 h-4 flex items-center justify-center';
        } else if (status === 'error') {
          icon.textContent = 'âŒ';
          icon.className = 'w-4 h-4 flex items-center justify-center';
        }
      }

      // YÃ¼kleme animasyonu fonksiyonu
      async function showLoadingAnimation() {
        loadingOverlay.classList.remove('hidden');
        
        // TÃ¼m kurallarÄ± baÅŸlangÄ±Ã§ durumuna getir
        for (let i = 1; i <= 8; i++) {
          updateRuleStatus(i, 'checking');
        }
        
        const rules = [
          { num: 1, name: 'Symmetry', delay: 500 },
          { num: 2, name: 'Balance', delay: 1000 },
          { num: 3, name: 'Adjacency', delay: 1250 },
          { num: 4, name: 'External Plies', delay: 1500 },
          { num: 5, name: 'Distribution', delay: 2000 },
          { num: 6, name: 'Grouping', delay: 2500 },
          { num: 7, name: 'Buckling', delay: 3000 },
          { num: 8, name: 'Lateral Bending', delay: 3500 },
        ];
        
        // Progress bar animasyonu
        let progress = 0;
        progressInterval = setInterval(() => {
          progress += 2;
          if (progress > 90) progress = 90; // Backend tamamlanana kadar 90'da kal
          loadingProgress.style.width = `${progress}%`;
          loadingProgressText.textContent = `${Math.round(progress)}%`;
        }, 100);
        
        // KurallarÄ± sÄ±rayla kontrol et
        for (let i = 0; i < rules.length; i++) {
          const rule = rules[i];
          const prevDelay = i > 0 ? rules[i - 1].delay : 0;
          await new Promise(resolve => setTimeout(resolve, rule.delay - prevDelay));
          updateRuleStatus(rule.num, 'checking');
          loadingStatus.textContent = `Checking Rule ${rule.num}: ${rule.name}...`;
          
          await new Promise(resolve => setTimeout(resolve, 300));
          updateRuleStatus(rule.num, 'done');
        }
        
        loadingStatus.textContent = 'Running Genetic Algorithm...';
        loadingProgress.style.width = '95%';
        loadingProgressText.textContent = '95%';
        
        return progressInterval;
      }

      function statusColor(value, invert = false) {
        if (value === '--') return 'text-slate-600';
        const good = invert ? value < 5 : value >= 90;
        return good ? 'text-emerald-700' : 'text-rose-700';
      }

      function getPenaltyExplanation(name, val) {
        const explanations = {
          'R1_Symmetry': val === 0 
            ? 'âœ… MÃ¼kemmel: Ä°lk ve son katmanlar simetrik olarak eÅŸleÅŸiyor.' 
            : 'âŒ Simetri bozulmasÄ±: KarÅŸÄ±lÄ±klÄ± katmanlar eÅŸleÅŸmiyor.',
          'R2_Balance': val === 0 
            ? 'âœ… MÃ¼kemmel: +45Â° ve -45Â° sayÄ±larÄ± dengeli (kuplaj Ã¶nleme).' 
            : 'âŒ Dengesizlik: +45Â° ve -45Â° sayÄ±larÄ± eÅŸit deÄŸil, kuplaj riski var.',
          'R3_Percentage': val === 0 
            ? 'âœ… MÃ¼kemmel: TÃ¼m aÃ§Ä±lar uygun yÃ¼zde aralÄ±ÄŸÄ±nda (8%-67%).' 
            : 'âŒ YÃ¼zde hatasÄ±: BazÄ± aÃ§Ä±lar izin verilen yÃ¼zde aralÄ±ÄŸÄ±nÄ±n dÄ±ÅŸÄ±nda.',
          'R3_Adjacency': val === "FORBIDDEN"
            ? 'ğŸš« YASAK: 0Â° ve 90Â° katmanlarÄ± yan yana olamaz (HARD RULE ihlali - Ã§Ã¶zÃ¼m geÃ§ersiz).'
            : (val === 0 
              ? 'âœ… MÃ¼kemmel: 0Â° ve 90Â° katmanlarÄ± yan yana deÄŸil.' 
              : 'âŒ KomÅŸuluk hatasÄ±: 0Â° ve 90Â° katmanlarÄ± yan yana olamaz.'),
          'R4_External': val === 0 
            ? 'âœ… MÃ¼kemmel: DÄ±ÅŸ katmanlar Â±45Â° ile baÅŸlayÄ±p bitiyor (hasar toleransÄ±).' 
            : 'âŒ DÄ±ÅŸ katman hatasÄ±: Ä°lk ve son katmanlar Â±45Â° olmalÄ±.',
          'R5_Distribution': val === 0 
            ? 'âœ… MÃ¼kemmel: AÃ§Ä±lar dÃ¶nÃ¼ÅŸÃ¼mlÃ¼ yerleÅŸtirilmiÅŸ (tek katman tercihi).' 
            : 'âŒ DaÄŸÄ±lÄ±m hatasÄ±: AynÄ± aÃ§Ä±lÄ± katmanlar ardÄ±ÅŸÄ±k yerleÅŸtirilmiÅŸ (dÃ¶nÃ¼ÅŸÃ¼mlÃ¼ yerleÅŸim tercih edilir).',
          'R6_Grouping': val === 0 
            ? 'âœ… MÃ¼kemmel: AynÄ± aÃ§Ä±lÄ± katmanlar 3\'ten fazla yan yana deÄŸil (yapÄ±sal bÃ¼tÃ¼nlÃ¼k).' 
            : 'âŒ Gruplama hatasÄ±: AynÄ± aÃ§Ä±lÄ± katmanlar Ã§ok fazla yan yana.',
          'R7_Buckling': val === 0 
            ? 'âœ… MÃ¼kemmel: UÃ§ bÃ¶lgelerde yeterli Â±45Â° katmanÄ± var (burkulma performansÄ±).' 
            : 'âŒ Burkulma riski: UÃ§ bÃ¶lgelerde Â±45Â° katmanlarÄ± yetersiz.',
          'R8_LateralBending': val === 0 
            ? 'âœ… MÃ¼kemmel: 90Â° katmanlarÄ± orta dÃ¼zlemden uzakta (lateral eÄŸilme sertliÄŸi).' 
            : 'âŒ Lateral eÄŸilme hatasÄ±: 90Â° katmanlarÄ± orta dÃ¼zleme Ã§ok yakÄ±n.',
          // Backward compatibility
          'R2_R5_Contiguity': val === 0 
            ? 'âœ… MÃ¼kemmel: +45Â° ve -45Â° katmanlarÄ± doÄŸru sÄ±rada.' 
            : 'âŒ ArdÄ±ÅŸÄ±klÄ±k hatasÄ±: Â±45Â° katmanlarÄ± yan yana gelmeli.',
          'CLT_Imbalance': val === 0 
            ? 'âœ… MÃ¼kemmel: +45Â° ve -45Â° sayÄ±larÄ± dengeli.' 
            : 'âŒ Dengesizlik: +45Â° ve -45Â° sayÄ±larÄ± eÅŸit deÄŸil.'
        };
        return explanations[name] || (val === 0 ? 'âœ… Kurala uygun.' : 'âŒ Kural ihlali tespit edildi.');
      }

      function renderPenalties(penalties) {
        penaltyListEl.innerHTML = '';
        const entries = Object.entries(penalties);
        if (!entries.length) {
          penaltyListEl.innerHTML = '<p class="text-slate-600 text-sm">No penalties recorded.</p>';
          return;
        }
        
        // Rule name mapping
        const ruleNames = {
          'R1': 'Symmetry',
          'R2': 'Balance',
          'R3': 'Adjacency',
          'R4': 'External Plies',
          'R5': 'Distribution',
          'R6': 'Grouping',
          'R7': 'Buckling',
          'R8': 'Lateral Bending'
        };

        // Rule purpose is shown in the right-side panel; keep rows compact here.
        
        entries.forEach(([ruleName, ruleData]) => {
          // Handle new format: ruleData is { weight, score, penalty, reason }
          const container = document.createElement('div');
          container.className = 'bg-white/70 backdrop-blur border border-slate-300/60 rounded-md px-3 py-2 space-y-1 shadow-sm';
          
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between';
          
          let weight, score, penalty, reason;
          if (typeof ruleData === 'object' && ruleData !== null && 'weight' in ruleData) {
            // New format
            weight = Number(ruleData.weight) || 0;
            score = Number(ruleData.score) || 0;
            penalty = Number(ruleData.penalty) || 0;
            reason = ruleData.reason || '';
          } else {
            // Legacy format (should not happen, but handle gracefully)
            weight = 100;
            score = typeof ruleData === 'number' ? (100 - ruleData) : 0;
            penalty = typeof ruleData === 'number' ? ruleData : 0;
            reason = '';
          }
          
          // Calculate percentage
          const percentage = weight > 0 ? (score / weight) * 100 : 0;
          
          // Determine color based on penalty
          const scoreColor = penalty === 0 ? 'text-emerald-700' : 'text-rose-700';
          
          // Display rule name with full name
          const fullRuleName = ruleNames[ruleName] ? `${ruleName} - ${ruleNames[ruleName]}` : ruleName;
          
          row.innerHTML = `<span class="text-slate-800 font-semibold">${fullRuleName}</span><span class="font-mono ${scoreColor}">${score.toFixed(2)} / ${weight.toFixed(2)} (${percentage.toFixed(1)}%)</span>`;
          
          const explanation = document.createElement('div');
          explanation.className = 'text-xs text-slate-600 mt-1';
          if (reason) {
            explanation.textContent = `âŒ ${reason}`;
          } else {
            explanation.textContent = 'âœ… Kurala uygun.';
          }
          
          container.appendChild(row);
          container.appendChild(explanation);
          penaltyListEl.appendChild(container);
        });
      }

      function renderChart() {
        // Chart removed per request; keep stub to avoid errors.
      }

      function renderLaminateMap(masterSeq, dropResults) {
        laminateMapEl.innerHTML = '';
        const colorMap = {
          '0': 'bg-emerald-500',
          '90': 'bg-sky-500',
          '45': 'bg-rose-500',
          '-45': 'bg-amber-500',
        };

        // Build sequence chain to track what was removed from where
        const sequenceChain = [masterSeq];
        dropResults.forEach(r => sequenceChain.push(r.seq));

        const stacks = [{ title: `Root (${masterSeq.length} ply)`, seq: masterSeq, isRoot: true }, ...dropResults.map((r, i) => ({ title: `Zone ${i + 1} (${r.target} ply)`, seq: r.seq, isRoot: false, dropData: r, prevSeq: sequenceChain[i] }))];
        const maxLen = masterSeq.length || 1;

        stacks.forEach((stack, stackIdx) => {
          // Container for each stack row
          const stackContainer = document.createElement('div');
          stackContainer.className = 'space-y-2';

          const row = document.createElement('div');
          row.className = 'flex items-start gap-4';

          const label = document.createElement('div');
          label.className = 'w-28 text-right text-xs text-slate-600 font-medium pt-1';
          label.textContent = stack.title;
          row.appendChild(label);

          const gridWrapper = document.createElement('div');
          gridWrapper.className = 'relative flex-1';
          
          const grid = document.createElement('div');
          grid.className = 'flex flex-wrap gap-[2px] bg-slate-100 p-2 rounded-md border border-slate-300 relative';
          
          // AÃ§Ä± sayÄ±larÄ±nÄ± hesapla
          const angleCounts = { 0: 0, 90: 0, 45: 0, '-45': 0 };
          stack.seq.forEach(angle => {
            const key = angle.toString();
            if (key in angleCounts) angleCounts[key]++;
          });
          const spacer = Math.floor((maxLen - stack.seq.length) / 2);

          // Add spacer blocks
          for (let i = 0; i < spacer; i++) {
            const empty = document.createElement('div');
            empty.className = 'w-7 h-7';
            grid.appendChild(empty);
          }

          // Add sequence blocks
          const seqLen = stack.seq.length;
          const midIndex = Math.floor(seqLen / 2);
          
          const isOddCount = seqLen % 2 === 1;  // Tek sayÄ±da ply mÄ±?
          
          stack.seq.forEach((angle, idx) => {
            // Orta Ã§izgisi - Tek sayÄ±da: ortadaki ply'Ä±n Ã¼zerine, Ã‡ift sayÄ±da: iki ply arasÄ±na
            if (!isOddCount && idx === midIndex) {
              // Ã‡ift sayÄ±da: Ä°ki ply arasÄ±na Ã§izgi
              const centerLine = document.createElement('div');
              centerLine.className = 'relative w-0 h-7 flex items-center justify-center';
              centerLine.innerHTML = `
                <div class="absolute w-[3px] h-10 bg-amber-500 z-10 shadow-[0_0_8px_rgba(245,158,11,0.35)]" style="margin-left: -1.5px;"></div>
              `;
              grid.appendChild(centerLine);
            }
            
            // Bu pozisyon drop-off'lardan birinde dÃ¼ÅŸÃ¼rÃ¼lmÃ¼ÅŸ mÃ¼ kontrol et
            let isDropped = false;
            let droppedInZone = '';
            
            // Her stack iÃ§in bir sonraki zone'daki drop'larÄ± kontrol et
            // Root (stackIdx=0) â†’ Zone 1 (dropResults[0]) kontrol eder
            // Zone 1 (stackIdx=1) â†’ Zone 2 (dropResults[1]) kontrol eder, vb.
            if (stackIdx < dropResults.length) {
              const nextDropData = dropResults[stackIdx];
              if (nextDropData && nextDropData.dropped && nextDropData.dropped.includes(idx)) {
                isDropped = true;
                droppedInZone = `Zone ${stackIdx + 1}`;
              }
            }
            
            const block = document.createElement('div');
            let blockClass = `w-7 h-7 rounded-sm ${colorMap[angle.toString()] || 'bg-slate-500'} flex items-center justify-center text-[9px] font-mono font-semibold text-white shadow-sm transition-all ring-1 ring-white/30`;
            
            // DÃ¼ÅŸÃ¼rÃ¼lmÃ¼ÅŸ katman ise Ã¶zel styling
            if (isDropped) {
              blockClass += ' opacity-30 line-through border-2 border-rose-500 border-dashed relative ring-0';
              block.title = `${angle}Â° - ${droppedInZone}'da Ã§Ä±karÄ±ldÄ± (Pozisyon ${idx})`;
              
              // Ãœzerine X iÅŸareti ekle
              const deleteIcon = document.createElement('div');
              deleteIcon.className = 'absolute -top-1 -right-1 w-3 h-3 bg-rose-600 rounded-full flex items-center justify-center text-[8px] text-white shadow-sm';
              deleteIcon.textContent = 'âœ•';
              deleteIcon.style.fontSize = '8px';
              deleteIcon.style.lineHeight = '1';
              block.style.position = 'relative';
            } else {
              block.title = `${angle}Â°`;
            }
            
            block.className = blockClass;
            block.textContent = `${angle}Â°`;
            block.dataset.index = idx; // Index'i sakla
            block.dataset.angle = angle; // AÃ§Ä±yÄ± sakla
            
            // Tek sayÄ±da ply: Ortadaki ply'Ä±n ortasÄ±na simetri Ã§izgisi ekle
            if (isOddCount && idx === midIndex) {
              block.style.position = 'relative';
              const centerLineOnPly = document.createElement('div');
              centerLineOnPly.className = 'absolute left-1/2 top-0 w-[3px] h-full bg-amber-500 z-20 shadow-[0_0_8px_rgba(245,158,11,0.35)]';
              centerLineOnPly.style.transform = 'translateX(-50%)';
              centerLineOnPly.style.height = '40px';  // Ply'dan biraz taÅŸsÄ±n
              centerLineOnPly.style.top = '-6px';
              block.appendChild(centerLineOnPly);
              block.title += ' (Simetri Ekseni)';
            }
            
            // Sadece master sequence (root) iÃ§in drag-and-drop Ã¶zelliÄŸi (dÃ¼ÅŸÃ¼rÃ¼lmemiÅŸ katmanlar iÃ§in)
            if (stackIdx === 0 && stack.isRoot && !isDropped) {
              block.draggable = true;
              block.className += ' cursor-move hover:scale-110 hover:ring-2 hover:ring-blue-500/40';
              block.title = `SÃ¼rÃ¼kle-bÄ±rak ile taÅŸÄ±: ${angle}Â°`;
              
              // Drag baÅŸladÄ±ÄŸÄ±nda
              block.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', idx.toString());
                block.style.opacity = '0.5';
                e.target.classList.add('dragging');
              });
              
              // Drag bittiÄŸinde
              block.addEventListener('dragend', (e) => {
                block.style.opacity = '1';
                e.target.classList.remove('dragging');
                // TÃ¼m drop zone'larÄ±n highlight'Ä±nÄ± kaldÄ±r
                grid.querySelectorAll('.drop-zone-active').forEach(el => {
                  el.classList.remove('drop-zone-active');
                });
              });
              
              // Ãœzerine gelindiÄŸinde (dragover)
              block.addEventListener('dragover', (e) => {
                if (e.preventDefault) {
                  e.preventDefault(); // Drop izni ver
                }
                e.dataTransfer.dropEffect = 'move';
                
                // Sadece baÅŸka bir block'un Ã¼zerindeyse highlight yap
                if (!e.target.classList.contains('dragging') && e.target.dataset.index !== undefined) {
                  e.target.classList.add('drop-zone-active');
                }
                return false;
              });
              
              // Ãœzerinden Ã§Ä±kÄ±ldÄ±ÄŸÄ±nda
              block.addEventListener('dragleave', (e) => {
                e.target.classList.remove('drop-zone-active');
              });
              
              // Drop edildiÄŸinde
              block.addEventListener('drop', (e) => {
                if (e.stopPropagation) {
                  e.stopPropagation(); // Event bubbling'i durdur
                }
                
                const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const dropIndex = parseInt(e.target.dataset.index);
                
                // GeÃ§erli deÄŸer kontrolÃ¼
                if (isNaN(draggedIndex) || isNaN(dropIndex)) {
                  e.target.classList.remove('drop-zone-active');
                  return false;
                }
                
                // AynÄ± pozisyona drop edilirse bir ÅŸey yapma
                if (draggedIndex === dropIndex) {
                  e.target.classList.remove('drop-zone-active');
                  return false;
                }
                
                // KatmanlarÄ± swap et
                const draggedAngle = stack.seq[draggedIndex];
                const dropAngle = stack.seq[dropIndex];
                
                stack.seq[draggedIndex] = dropAngle;
                stack.seq[dropIndex] = draggedAngle;
                
                // currentMasterSequence'Ä± gÃ¼ncelle
                if (currentMasterSequence) {
                  currentMasterSequence[draggedIndex] = dropAngle;
                  currentMasterSequence[dropIndex] = draggedAngle;
                }
                
                // DOM'u gÃ¼ncelle - block'larÄ±n iÃ§eriÄŸini ve rengini deÄŸiÅŸtir
                const draggedBlock = grid.querySelector(`[data-index="${draggedIndex}"]`);
                const dropBlock = grid.querySelector(`[data-index="${dropIndex}"]`);
                
                if (draggedBlock && dropBlock) {
                  draggedBlock.textContent = `${dropAngle}Â°`;
                  draggedBlock.dataset.angle = dropAngle;
                  draggedBlock.className = `w-7 h-7 rounded-sm ${colorMap[dropAngle.toString()]} flex items-center justify-center text-[9px] font-mono font-semibold text-white shadow-sm transition-all ring-1 ring-white/30 cursor-move hover:scale-110 hover:ring-2 hover:ring-blue-500/40`;
                  draggedBlock.title = `SÃ¼rÃ¼kle-bÄ±rak ile taÅŸÄ±: ${dropAngle}Â°`;
                  
                  dropBlock.textContent = `${draggedAngle}Â°`;
                  dropBlock.dataset.angle = draggedAngle;
                  dropBlock.className = `w-7 h-7 rounded-sm ${colorMap[draggedAngle.toString()]} flex items-center justify-center text-[9px] font-mono font-semibold text-white shadow-sm transition-all ring-1 ring-white/30 cursor-move hover:scale-110 hover:ring-2 hover:ring-blue-500/40`;
                  dropBlock.title = `SÃ¼rÃ¼kle-bÄ±rak ile taÅŸÄ±: ${draggedAngle}Â°`;
                }
                
                e.target.classList.remove('drop-zone-active');
                return false;
              });
            } else {
            block.title = `${angle}Â°`;
            }
            
            grid.appendChild(block);
          });

          gridWrapper.appendChild(grid);
          row.appendChild(gridWrapper);
          
          // SaÄŸ tarafta aÃ§Ä± sayÄ±larÄ±nÄ± gÃ¶ster
          const angleCountsDiv = document.createElement('div');
          angleCountsDiv.className = 'w-36 text-xs pt-1 space-y-0.5 bg-white/70 backdrop-blur border border-slate-300/60 rounded-md px-2 py-1.5 shadow-sm';
          angleCountsDiv.innerHTML = `
            <div class="flex justify-between"><span class="text-emerald-700 font-medium">0Â°:</span> <span class="font-mono text-slate-800">${angleCounts['0']}</span></div>
            <div class="flex justify-between"><span class="text-sky-700 font-medium">90Â°:</span> <span class="font-mono text-slate-800">${angleCounts['90']}</span></div>
            <div class="flex justify-between"><span class="text-rose-700 font-medium">45Â°:</span> <span class="font-mono text-slate-800">${angleCounts['45']}</span></div>
            <div class="flex justify-between"><span class="text-amber-700 font-medium">-45Â°:</span> <span class="font-mono text-slate-800">${angleCounts['-45']}</span></div>
          `;
          row.appendChild(angleCountsDiv);
          
          stackContainer.appendChild(row);

          // Drop-off optimization rules explanation for zones
          if (!stack.isRoot && stack.dropData && stack.prevSeq) {
            const droppedIndices = stack.dropData.dropped || [];
            const droppedCount = droppedIndices.length;
            const removedPairs = droppedCount / 2;
            
            // Get removed ply angles from previous sequence
            const removedPlies = droppedIndices.map(idx => stack.prevSeq[idx]).filter(a => a !== undefined);
            
            // Count removed plies by angle and group their positions
            const removedCounts = {};
            const removedPositionsByAngle = {};
            
            droppedIndices.forEach(idx => {
              const angle = stack.prevSeq[idx];
              if (angle !== undefined) {
              removedCounts[angle] = (removedCounts[angle] || 0) + 1;
                if (!removedPositionsByAngle[angle]) {
                  removedPositionsByAngle[angle] = [];
                }
                removedPositionsByAngle[angle].push(idx);
              }
            });
            
            // Format removed plies display
            const removedDisplay = Object.entries(removedCounts)
              .map(([angle, count]) => `${angle}Â° (${count})`)
              .join(', ') || 'Yok';
            
            // Format removed positions by angle
            const removedPositionsDisplay = Object.entries(removedPositionsByAngle)
              .map(([angle, positions]) => {
                const sortedPos = positions.sort((a, b) => a - b);
                return `<div class="ml-4"><span class="text-rose-700 font-mono font-semibold">${angle}Â°</span> â†’ Pozisyon: <span class="font-mono text-slate-800">${sortedPos.join(', ')}</span></div>`;
              })
              .join('') || '<div class="ml-4 text-slate-600">Yok</div>';
            
            const rulesInfo = document.createElement('div');
            rulesInfo.className = 'ml-32 bg-slate-50 border border-slate-200 rounded-md px-3 py-2 text-xs text-slate-600 shadow-sm';
            rulesInfo.innerHTML = `
              <div class="flex items-start gap-2">
                <span class="text-blue-700 text-base">âš™ï¸</span>
                <div class="flex-1 space-y-1.5">
                  <div class="font-semibold text-slate-800 mb-1.5">Drop-Off Bilgisi:</div>
                  <div class="flex items-start gap-2">
                    <span class="text-rose-700 font-mono">âœ—</span>
                    <div class="flex-1">
                      <div><span class="text-slate-700">Ã‡Ä±karÄ±lan Ply'ler:</span> <span class="font-mono text-rose-700 font-semibold">${removedDisplay}</span> (toplam ${droppedCount} ply)</div>
                      <div class="mt-1.5 pt-1.5 border-t border-slate-200">
                        <div class="text-slate-600 mb-1">Ã‡Ä±karÄ±lan Pozisyonlar:</div>
                        ${removedPositionsDisplay}
                  </div>
                  </div>
                  </div>
                </div>
              </div>
            `;
            stackContainer.appendChild(rulesInfo);
          }

          laminateMapEl.appendChild(stackContainer);
        });
      }

      function renderSummary(data) {
        const stats = data.stats || {};
        summaryRuntimeEl.textContent = `SÃ¼re: ${stats.duration_seconds ?? '--'}s`;
        summaryParamsEl.innerHTML = `
          <div>PopÃ¼lasyon: <span class="font-mono text-slate-900">${stats.population_size ?? '--'}</span></div>
          <div>Jenerasyon: <span class="font-mono text-slate-900">${stats.generations ?? '--'}</span></div>
          <div>Toplam Ply: <span class="font-mono text-slate-900">${stats.plies ?? '--'}</span></div>
        `;
        summaryMasterEl.innerHTML = '';
        (data.master_sequence || []).forEach((ang) => {
          const chip = document.createElement('span');
          chip.className = 'px-2 py-1 rounded-md bg-white/70 backdrop-blur border border-slate-300/60 text-xs font-mono text-slate-800 shadow-sm';
          chip.textContent = `${ang}Â°`;
          summaryMasterEl.appendChild(chip);
        });
        const drops = data.drop_off_results || [];
        if (!drops.length) {
          summaryDropEl.innerHTML = '<div class="text-slate-600">Drop-off uygulanmadÄ±.</div>';
        } else {
          summaryDropEl.innerHTML = '';
          drops.forEach((d) => {
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between bg-white/70 backdrop-blur border border-slate-300/60 rounded-md px-2 py-1 shadow-sm';
            const score = d.score ?? 0;
            // Drop-off skorlarÄ± yeÅŸil renkte, 100 Ã¼zerinden gÃ¶ster
            row.innerHTML = `<span class="text-slate-700">Hedef ${d.target} ply</span><span class="font-mono text-emerald-700">${score.toFixed(2)} / 100</span>`;
            summaryDropEl.appendChild(row);
          });
        }
      }

      async function runOptimization(formData) {
        // Loading animasyonunu baÅŸlat
        const progressInterval = await showLoadingAnimation();
        
        runMetaEl.textContent = 'Running...';
        const payload = {
          ply_counts: {
            0: Number(formData.get('0')),
            90: Number(formData.get('90')),
            45: Number(formData.get('45')),
            '-45': Number(formData.get('-45')),
          },
          population_size: Number(formData.get('population_size')),
          generations: Number(formData.get('generations')),
        };

        try {
          const response = await fetch(`${API_BASE}/optimize`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (!response.ok) throw new Error('Optimization failed');
          
          const data = await response.json();
          
          // Simetri kontrolÃ¼ - kullanÄ±cÄ± seÃ§imi gerekiyor mu?
          if (data.requires_symmetry_choice) {
            if (progressInterval) clearInterval(progressInterval);
            loadingOverlay.classList.add('hidden');
            
            return new Promise((resolve, reject) => {
              showSymmetryWarning(data.symmetry_info, async (choice) => {
                if (choice === null) {
                  // KullanÄ±cÄ± "mevcut sayÄ±larla devam" seÃ§ti - null gÃ¶nder
                  payload.symmetry_user_choice = { continue_with_current: true };
                } else {
                  // KullanÄ±cÄ± bir Ã¶neri seÃ§ti
                  payload.symmetry_user_choice = choice;
                }
                
                // Loading'i yeniden baÅŸlat
                const newProgressInterval = await showLoadingAnimation();
                runMetaEl.textContent = 'Running...';
                
                try {
                  const retryResponse = await fetch(`${API_BASE}/optimize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                  });
                  if (!retryResponse.ok) throw new Error('Optimization failed');
                  
                  // Progress'i tamamla
                  if (newProgressInterval) clearInterval(newProgressInterval);
                  loadingProgress.style.width = '100%';
                  loadingProgressText.textContent = '100%';
                  loadingStatus.textContent = 'Optimization Complete!';
                  
                  await new Promise(r => setTimeout(r, 500));
                  loadingOverlay.classList.add('hidden');
                  
                  const retryData = await retryResponse.json();
                  resolve(retryData);
                } catch (err) {
                  if (newProgressInterval) clearInterval(newProgressInterval);
                  loadingOverlay.classList.add('hidden');
                  reject(err);
                }
              });
            });
          }
          
          // Progress'i tamamla
          if (progressInterval) clearInterval(progressInterval);
          loadingProgress.style.width = '100%';
          loadingProgressText.textContent = '100%';
          loadingStatus.textContent = 'Optimization Complete!';
          
          await new Promise(resolve => setTimeout(resolve, 500));
          loadingOverlay.classList.add('hidden');
          
          return data;
        } catch (error) {
          if (progressInterval) clearInterval(progressInterval);
          loadingOverlay.classList.add('hidden');
          throw error;
        }
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        try {
          const data = await runOptimization(formData);
          emptyState.classList.add('hidden');
          resultsSection.classList.remove('hidden');
          
          // Zone management iÃ§in master sequence'i sakla
          currentMasterSequence = data.master_sequence || [];
          originalMasterSequence = data.master_sequence || []; // Orijinal master'Ä± sakla
          
          // Ply counts'u Ã¶nce set et (root zone oluÅŸturulmadan Ã¶nce)
          currentPlyCounts = {
            0: Number(formData.get('0')),
            90: Number(formData.get('90')),
            45: Number(formData.get('45')),
            '-45': Number(formData.get('-45')),
          };
          
          if (data.master_sequence) {
            // Zone management section'Ä± gÃ¶ster
            zoneManagementSection.classList.remove('hidden');
            
            // Root zone'u otomatik oluÅŸtur
            try {
              const initResponse = await fetch(`${API_BASE}/zones/init_root`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  session_id: currentSessionId,
                  master_sequence: data.master_sequence,
                  ply_counts: currentPlyCounts
                })
              });
              if (initResponse.ok) {
                const initData = await initResponse.json();
                currentZones = initData.all_zones || [];
                currentTransitions = initData.transitions || [];
                lastDropoffSourceZoneId = 0; // Root zone ID
                renderZoneList();
                renderZoneDiagram();
                updateZoneSelects();
              }
            } catch (error) {
              console.error('Root zone oluÅŸturma hatasÄ±:', error);
            }
          }

          // Fitness Score: Display as total_score / max_score
          const fitnessScore = Number(data.fitness_score) || 0;
          const maxScore = Number(data.max_score) || 100;
          const fitnessPercentage = maxScore > 0 ? (fitnessScore / maxScore) * 100 : 0;
          fitnessScoreEl.textContent = `${fitnessScore.toFixed(2)} / ${maxScore.toFixed(2)}`;
          fitnessScoreEl.className = `text-3xl font-bold ${fitnessPercentage >= 90 ? 'text-emerald-700' : fitnessPercentage >= 70 ? 'text-amber-700' : 'text-rose-700'}`;
          
          // Fitness hint: Show percentage and status
          fitnessHintEl.innerHTML = `
            <span class="text-slate-500">ğŸ’¡</span> 
            ${fitnessPercentage >= 90 ? 'MÃ¼kemmel' : fitnessPercentage >= 70 ? 'Ä°yi' : 'GeliÅŸtirilebilir'} skor (${fitnessPercentage.toFixed(1)}%).
          `;

          // Symmetry Score: Use new format
          const symRule = data.penalties?.R1;
          let symScore = 0, symWeight = 100, symPenalty = 0, symReason = '';
          if (symRule && typeof symRule === 'object') {
            symScore = Number(symRule.score) || 0;
            symWeight = Number(symRule.weight) || 100;
            symPenalty = Number(symRule.penalty) || 0;
            symReason = symRule.reason || '';
          }
          const symPercentage = symWeight > 0 ? (symScore / symWeight) * 100 : 0;
          symmetryPenaltyEl.textContent = `${symScore.toFixed(2)} / ${symWeight.toFixed(2)}`;
          symmetryPenaltyEl.className = `text-2xl font-mono mt-2 ${symPenalty === 0 ? 'text-emerald-700' : 'text-rose-700'}`;
          symmetryHintEl.innerHTML = `
            <span class="text-slate-500">ğŸ’¡</span> 
            ${symPenalty === 0 ? 'MÃ¼kemmel simetri: Ä°lk ve son katmanlar eÅŸleÅŸiyor.' : `Simetri hatasÄ±: ${symReason || `${symPenalty.toFixed(2)} puan kaybÄ±`}.`}
          `;

          // Balance Score: Use new format
          const balanceRule = data.penalties?.R2;
          let balanceScore = 0, balanceWeight = 100, balancePenalty = 0, balanceReason = '';
          if (balanceRule && typeof balanceRule === 'object') {
            balanceScore = Number(balanceRule.score) || 0;
            balanceWeight = Number(balanceRule.weight) || 100;
            balancePenalty = Number(balanceRule.penalty) || 0;
            balanceReason = balanceRule.reason || '';
          }
          const balancePercentage = balanceWeight > 0 ? (balanceScore / balanceWeight) * 100 : 0;
          balanceScoreEl.textContent = `${balanceScore.toFixed(2)} / ${balanceWeight.toFixed(2)}`;
          balanceScoreEl.className = `text-2xl font-mono mt-2 ${balancePenalty === 0 ? 'text-emerald-700' : 'text-rose-700'}`;
          balanceHintEl.innerHTML = `
            <span class="text-slate-500">ğŸ’¡</span> 
            ${balancePenalty === 0 ? 'Dengeli: +45Â° ve -45Â° sayÄ±larÄ± eÅŸit (kuplaj Ã¶nleme).' : `Dengesizlik: ${balanceReason || `${balancePenalty.toFixed(2)} puan kaybÄ±`}.`}
          `;

          statsMetaEl.textContent = `${data.stats.plies} ply â€¢ pop ${data.stats.population_size} â€¢ ${data.stats.generations} generations â€¢ ${data.stats.duration_seconds}s`;
          runMetaEl.textContent = `Completed in ${data.stats.duration_seconds}s`;

          // Current sequence ve ply counts'u sakla
          currentMasterSequence = [...(data.master_sequence || [])];
          originalMasterSequence = [...(data.master_sequence || [])]; // Orijinal master sequence'Ä± sakla
          currentPlyCounts = {
            0: Number(formData.get('0')),
            90: Number(formData.get('90')),
            45: Number(formData.get('45')),
            '-45': Number(formData.get('-45')),
          };
          dropOffResults = [...(data.drop_off_results || [])]; // Drop-off sonuÃ§larÄ±nÄ± sakla

          // Mevcut ply sayÄ±sÄ±nÄ± gÃ¼ncelle
          if (currentPlyCountEl) {
            currentPlyCountEl.textContent = currentMasterSequence.length;
          }

          renderSummary(data);
          renderPenalties(data.penalties || {});
          renderChart(data.history || []);
          renderLaminateMap(data.master_sequence || [], dropOffResults);
        } catch (err) {
          console.error(err);
          runMetaEl.textContent = 'Error: ' + err.message;
        }
      });

      // Drop-Off butonu event listener
      if (applyDropoffBtn && dropoffTargetInput) {
        applyDropoffBtn.addEventListener('click', async () => {
          if (!currentMasterSequence || !currentPlyCounts) {
            alert('LÃ¼tfen Ã¶nce bir optimizasyon Ã§alÄ±ÅŸtÄ±rÄ±n.');
            return;
          }

          const targetPly = parseInt(dropoffTargetInput.value);
          if (isNaN(targetPly) || targetPly <= 0) {
            alert('LÃ¼tfen geÃ§erli bir ply sayÄ±sÄ± girin.');
            return;
          }

          if (targetPly >= currentMasterSequence.length) {
            alert(`Hedef ply sayÄ±sÄ± (${targetPly}) mevcut ply sayÄ±sÄ±ndan (${currentMasterSequence.length}) kÃ¼Ã§Ã¼k olmalÄ±.`);
            return;
          }

          applyDropoffBtn.disabled = true;
          applyDropoffBtn.textContent = 'Drop-Off UygulanÄ±yor...';

          try {
            const response = await fetch(`${API_BASE}/dropoff`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                master_sequence: currentMasterSequence,
                target_ply: targetPly,
                ply_counts: currentPlyCounts
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || 'Drop-off baÅŸarÄ±sÄ±z');
            }

            const data = await response.json();

            // Drop-off sonucunu listeye ekle
            const dropoffResult = {
              target: data.target_ply,
              seq: data.sequence,
              score: data.fitness_score,
              dropped: data.dropped_indices
            };
            dropOffResults.push(dropoffResult);

            // Zone sistemine ekle
            await addDropoffToZones(dropoffResult, lastDropoffSourceZoneId);

            // Master sequence'Ä± gÃ¼ncelle (son drop-off sonucu yeni master olur)
            currentMasterSequence = [...data.sequence];
            
            // Mevcut ply sayÄ±sÄ±nÄ± gÃ¼ncelle
            if (currentPlyCountEl) {
              currentPlyCountEl.textContent = currentMasterSequence.length;
            }

            // Input'u temizle
            dropoffTargetInput.value = '';

            // Laminate map'i gÃ¼ncelle - orijinal master sequence ile tÃ¼m drop-off sonuÃ§larÄ±nÄ± gÃ¶ster
            const masterForDisplay = originalMasterSequence || currentMasterSequence;
            renderLaminateMap(masterForDisplay, dropOffResults);

            // BaÅŸarÄ± mesajÄ±
            runMetaEl.textContent = `Drop-off uygulandÄ±: ${data.original_ply} â†’ ${data.target_ply} ply (${data.removed_count} katman silindi). Skor: ${data.fitness_score.toFixed(2)}`;

          } catch (err) {
            console.error(err);
            alert('Hata: ' + err.message);
          } finally {
            applyDropoffBtn.disabled = false;
            applyDropoffBtn.textContent = 'Drop-Off Uygula';
          }
        });

        // Enter tuÅŸu ile de drop-off yapÄ±labilir
        if (dropoffTargetInput) {
          dropoffTargetInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              applyDropoffBtn.click();
            }
          });
        }
      }

      // AÃ§Ä±ya Ã¶zel Drop-Off butonu event listener
      const applyDropoffAngleBtn = document.getElementById('apply-dropoff-angle-btn');
      const dropoffSourceZoneSelect = document.getElementById('dropoff-source-zone-select');
      const planSchematicEl = document.getElementById('plan-schematic');
      const dropoffAngle0 = document.getElementById('dropoff-angle-0');
      const dropoffAngle90 = document.getElementById('dropoff-angle-90');
      const dropoffAngle45 = document.getElementById('dropoff-angle-45');
      const dropoffAngleM45 = document.getElementById('dropoff-angle-m45');

      if (applyDropoffAngleBtn) {
        applyDropoffAngleBtn.addEventListener('click', async () => {
          if (!currentMasterSequence || !currentPlyCounts) {
            alert('LÃ¼tfen Ã¶nce bir optimizasyon Ã§alÄ±ÅŸtÄ±rÄ±n.');
            return;
          }

          // Kaynak zone seÃ§imi (master veya zone)
          let sourceMode = 'master';
          let sourceZoneIdForZones = lastDropoffSourceZoneId ?? 0;
          let sourceSequence = currentMasterSequence;
          if (dropoffSourceZoneSelect && dropoffSourceZoneSelect.value && dropoffSourceZoneSelect.value !== 'master') {
            const chosenId = parseInt(dropoffSourceZoneSelect.value);
            if (!isNaN(chosenId)) {
              const chosenZone = (currentZones || []).find(z => z.zone_id === chosenId);
              if (chosenZone && Array.isArray(chosenZone.sequence)) {
                sourceMode = 'zone';
                sourceZoneIdForZones = chosenZone.zone_id;
                sourceSequence = chosenZone.sequence;
              }
            }
          }

          // Input deÄŸerlerini al
          const target0 = dropoffAngle0.value ? parseInt(dropoffAngle0.value) : null;
          const target90 = dropoffAngle90.value ? parseInt(dropoffAngle90.value) : null;
          const target45 = dropoffAngle45.value ? parseInt(dropoffAngle45.value) : null;
          const targetM45 = dropoffAngleM45.value ? parseInt(dropoffAngleM45.value) : null;

          // En az bir deÄŸer girilmiÅŸ mi kontrol et
          if (target0 === null && target90 === null && target45 === null && targetM45 === null) {
            alert('LÃ¼tfen en az bir aÃ§Ä± iÃ§in hedef sayÄ± girin.');
            return;
          }

          // Target ply counts objesi oluÅŸtur (sadece girilen deÄŸerler)
          const targetPlyCounts = {};
          if (target0 !== null) targetPlyCounts['0'] = target0;
          if (target90 !== null) targetPlyCounts['90'] = target90;
          if (target45 !== null) targetPlyCounts['45'] = target45;
          if (targetM45 !== null) targetPlyCounts['-45'] = targetM45;

          // Validation: Hedef sayÄ±lar mevcut sayÄ±lardan fazla olmamalÄ±
          const currentCounts = {};
          sourceSequence.forEach(angle => {
            currentCounts[angle] = (currentCounts[angle] || 0) + 1;
          });

          for (const [angle, targetCount] of Object.entries(targetPlyCounts)) {
            const current = currentCounts[parseInt(angle)] || 0;
            if (targetCount > current) {
              alert(`Hata: ${angle}Â° iÃ§in hedef ${targetCount} ama mevcut sadece ${current} katman var.`);
            return;
            }
            if (targetCount < 0) {
              alert(`Hata: ${angle}Â° iÃ§in hedef sayÄ± negatif olamaz.`);
              return;
            }
          }

          applyDropoffAngleBtn.disabled = true;
          applyDropoffAngleBtn.textContent = 'AÃ§Ä±ya Ã–zel Drop-Off UygulanÄ±yor...';

          try {
            const response = await fetch(`${API_BASE}/dropoff_angle_targets`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                master_sequence: sourceSequence,
                target_ply_counts: targetPlyCounts
              })
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || 'AÃ§Ä±ya Ã¶zel drop-off baÅŸarÄ±sÄ±z');
            }

            const data = await response.json();

            // Toplam hedef ply sayÄ±sÄ±nÄ± hesapla
            const totalTarget = Object.values(targetPlyCounts).reduce((sum, val) => sum + val, 0);

            // Drop-off sonucunu listeye ekle
            const dropoffResult = {
              target: totalTarget,
              seq: data.sequence,
              score: data.fitness_score,
              dropped: Object.values(data.dropped_by_angle || {}).flat() // TÃ¼m dÃ¼ÅŸÃ¼rÃ¼len indexleri birleÅŸtir
            };
            dropOffResults.push(dropoffResult);

            // Zone sistemine ekle
            await addDropoffToZones(dropoffResult, sourceZoneIdForZones);
            
            // Sadece master modunda ardÄ±ÅŸÄ±k Ã§alÄ±ÅŸmayÄ± koru
            if (sourceMode === 'master') {
              currentMasterSequence = [...data.sequence];
            if (currentPlyCountEl) {
              currentPlyCountEl.textContent = currentMasterSequence.length;
              }
            }

            // Input'larÄ± temizle
            dropoffAngle0.value = '';
            dropoffAngle90.value = '';
            dropoffAngle45.value = '';
            dropoffAngleM45.value = '';

            // Laminate map'i gÃ¼ncelle
            if (sourceMode === 'master') {
            const masterForDisplay = originalMasterSequence || currentMasterSequence;
            renderLaminateMap(masterForDisplay, dropOffResults);
            } else {
              // Zone kaynaklÄ± drop-off: indeksler farklÄ± olabileceÄŸi iÃ§in sadece bu sonucu gÃ¶ster
              renderLaminateMap(sourceSequence, [dropoffResult]);
            }

            // DetaylÄ± baÅŸarÄ± mesajÄ±
            const removedDetails = Object.entries(data.dropped_by_angle || {})
              .map(([angle, indices]) => `${angle}Â°: ${indices.length / 2} Ã§ift`)
              .join(', ');
            
            runMetaEl.textContent = `AÃ§Ä±ya Ã¶zel drop-off uygulandÄ±: ${data.original_total} â†’ ${data.new_total} ply (${removedDetails}). Skor: ${data.fitness_score.toFixed(2)}`;

          } catch (err) {
            console.error(err);
            alert('Hata: ' + err.message);
          } finally {
            applyDropoffAngleBtn.disabled = false;
            applyDropoffAngleBtn.textContent = 'AÃ§Ä±ya Ã–zel Drop-Off Uygula';
          }
        });
      }

      // Keep schematic highlight in sync with dropdown source selection
      if (dropoffSourceZoneSelect) {
        dropoffSourceZoneSelect.addEventListener('change', () => {
          // Render using currentZones/currentTransitions (if available)
          try { renderPlanSchematic(); } catch (_) {}
        });
      }

      // Simetri UyarÄ± ModalÄ±
      const symmetryModal = document.createElement('div');
      symmetryModal.id = 'symmetry-modal';
      symmetryModal.className = 'fixed inset-0 bg-black/70 z-50 flex items-center justify-center hidden';
      symmetryModal.innerHTML = `
        <div class="bg-white rounded-xl border border-slate-200 p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto shadow-xl">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-3xl">âš ï¸</span>
            <h3 class="text-xl font-bold text-slate-900">Simetri UyarÄ±sÄ±</h3>
          </div>
          <div id="symmetry-issues" class="space-y-3 mb-4 text-sm text-slate-700"></div>
          <div id="symmetry-suggestions" class="space-y-2 mb-4"></div>
          <div class="flex gap-3 justify-end pt-4 border-t border-slate-200">
            <button id="symmetry-cancel-btn" class="button-with-icon btn-slate">
              Ä°ptal
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(symmetryModal);

      function showSymmetryWarning(symmetryInfo, onChoice) {
        const issuesEl = document.getElementById('symmetry-issues');
        const suggestionsEl = document.getElementById('symmetry-suggestions');
        
        issuesEl.innerHTML = symmetryInfo.issues.map(issue => 
          `<div class="bg-amber-50 p-3 rounded-md border border-amber-200">
            <p class="text-amber-900">${issue.message}</p>
          </div>`
        ).join('');
        
        suggestionsEl.innerHTML = '';
        if (symmetryInfo.suggestions && symmetryInfo.suggestions.length > 0) {
          suggestionsEl.innerHTML = '<div class="text-sm font-semibold text-slate-800 mb-2">Ã–neriler:</div>';
          symmetryInfo.suggestions.forEach((suggestion, idx) => {
            const btn = document.createElement('button');
            btn.className = 'w-full text-left px-4 py-3 bg-white hover:bg-slate-50 border border-slate-200 rounded-md transition-colors mb-2 shadow-sm';
            btn.innerHTML = `
              <div class="text-slate-800 font-medium">${suggestion.description}</div>
            `;
            btn.onclick = () => {
              symmetryModal.classList.add('hidden');
              onChoice(suggestion);
            };
            suggestionsEl.appendChild(btn);
          });
          
          // "Mevcut sayÄ±larla devam et" seÃ§eneÄŸi
          const continueBtn = document.createElement('button');
          continueBtn.className = 'w-full text-left px-4 py-3 bg-amber-50 hover:bg-amber-100 border border-amber-300 rounded-md transition-colors mt-2';
          continueBtn.innerHTML = `
            <div class="text-amber-900 font-medium">âš ï¸ Mevcut sayÄ±larla devam et (kÃ¼Ã§Ã¼k simetri penalty'si kabul edilir)</div>
          `;
          continueBtn.onclick = () => {
            symmetryModal.classList.add('hidden');
            onChoice(null); // null = mevcut sayÄ±larla devam
          };
          suggestionsEl.appendChild(continueBtn);
        }
        
        document.getElementById('symmetry-cancel-btn').onclick = () => {
          symmetryModal.classList.add('hidden');
        };
        
        symmetryModal.classList.remove('hidden');
      }

      // Zone Management
      const zoneManagementSection = document.getElementById('zone-management-section');
      const zoneDiagram = document.getElementById('zone-diagram');
      const zoneList = document.getElementById('zone-list');
      const initRootZoneBtn = document.getElementById('init-root-zone-btn');
      const mergeZonesSelect = document.getElementById('merge-zones-select');
      const createZoneMergeBtn = document.getElementById('create-zone-merge-btn');
      
      let currentSessionId = 'default';
      let currentZones = [];
      let currentTransitions = [];
      let lastDropoffSourceZoneId = 0; // Son drop-off'un kaynak zone ID'si
      // Plan ÅŸemasÄ± iÃ§in (fotoÄŸraf benzeri) otomatik yerleÅŸim ipuÃ§larÄ±
      // slot: 0=Ã¼st, 1=orta, 2=alt (kolon iÃ§i)
      // col: kolon index (depth) override (Ã¶rn. ÃœSTÃœNE/ALTINA aynÄ± kolon)
      // kind: 'global' (kolon Ã¼st/orta/alt) | 'above' (kaynaÄŸÄ±n Ã¼stÃ¼ne) | 'below' (kaynaÄŸÄ±n altÄ±na)
      let planLayoutHints = {}; // zone_id -> { slot: 0|1|2, col?: number, kind?: string, anchor?: number }
      let pendingPlanDrop = null; // { sourceZoneId, targetDepth, slot, kind?: string }
      let planPinnedTooltipZoneId = null; // Katman dizilimi panelini "pin"lemek iÃ§in (DIZ butonu)

      // Kaynak Zone SeÃ§im ModalÄ±
      const sourceZoneModal = document.createElement('div');
      sourceZoneModal.id = 'source-zone-modal';
      sourceZoneModal.className = 'fixed inset-0 bg-black/70 z-50 flex items-center justify-center hidden';
      sourceZoneModal.innerHTML = `
        <div class="bg-white rounded-xl border border-slate-200 p-6 max-w-md w-full mx-4 shadow-xl">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-2xl">ğŸ”—</span>
            <h3 class="text-lg font-bold text-slate-900">Kaynak Zone SeÃ§in</h3>
          </div>
          <p class="text-sm text-slate-700 mb-4">
            Bu drop-off hangi zone'dan dallanacak?
          </p>
          <select id="modal-source-zone-select" class="w-full bg-white border border-slate-300 rounded-md px-3 py-2 text-sm text-slate-900 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">SeÃ§iniz...</option>
          </select>
          <div class="flex gap-3 justify-end">
            <button id="modal-cancel-btn" class="button-with-icon btn-slate">
              Ä°ptal
            </button>
            <button id="modal-confirm-btn" class="button-with-icon btn-blue">
              Onayla
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(sourceZoneModal);

      function showSourceZoneModal(zones) {
        return new Promise((resolve, reject) => {
          const select = document.getElementById('modal-source-zone-select');
          select.innerHTML = '<option value="">SeÃ§iniz...</option>';
          zones.forEach(zone => {
            const option = document.createElement('option');
            option.value = zone.zone_id;
            option.textContent = `${zone.name} (${zone.ply_count} ply)`;
            select.appendChild(option);
          });
          
          // VarsayÄ±lan olarak en son zone'u seÃ§
          if (zones.length > 0) {
            const maxZone = zones.reduce((max, zone) => 
              zone.zone_id > max.zone_id ? zone : max
            );
            select.value = maxZone.zone_id;
          }
          
          document.getElementById('modal-confirm-btn').onclick = () => {
            const selectedId = parseInt(select.value);
            if (selectedId !== null && !isNaN(selectedId)) {
              sourceZoneModal.classList.add('hidden');
              resolve(selectedId);
            } else {
              alert('LÃ¼tfen bir zone seÃ§in.');
            }
          };
          
          document.getElementById('modal-cancel-btn').onclick = () => {
            sourceZoneModal.classList.add('hidden');
            reject(new Error('Ä°ptal edildi'));
          };
          
          sourceZoneModal.classList.remove('hidden');
        });
      }

      // Eski drop-off sonuÃ§larÄ±nÄ± zone sistemine ekle
      async function addDropoffToZones(dropoffData, sourceZoneId = null) {
        try {
          // EÄŸer zone'lar yoksa, yÃ¼kle veya root oluÅŸtur
          if (currentZones.length === 0) {
            if (originalMasterSequence && originalMasterSequence.length > 0) {
              // Root zone oluÅŸtur
              const initResponse = await fetch(`${API_BASE}/zones/init_root`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  session_id: currentSessionId,
                  master_sequence: originalMasterSequence,
                  ply_counts: currentPlyCounts
                })
              });
              if (initResponse.ok) {
                const initData = await initResponse.json();
                currentZones = initData.all_zones || [];
                currentTransitions = initData.transitions || [];
                zoneManagementSection.classList.remove('hidden');
                lastDropoffSourceZoneId = 0; // Root zone ID
              }
            } else {
              // Zone'larÄ± yÃ¼kle
              await loadZones();
            }
          }
          
          // Source zone ID belirlenmediyse, kullanÄ±cÄ±ya seÃ§tir
          if (sourceZoneId === null) {
            if (currentZones.length > 0) {
              try {
                sourceZoneId = await showSourceZoneModal(currentZones);
              } catch (error) {
                // KullanÄ±cÄ± iptal etti, zone ekleme
                return;
              }
            } else {
              // Zone yoksa root'u kullan
              sourceZoneId = 0;
            }
          }
          
          // Yeni zone'u backend'e ekle
          const response = await fetch(`${API_BASE}/zones/add_from_dropoff`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              session_id: currentSessionId,
              source_zone_id: sourceZoneId,
              sequence: dropoffData.seq,
              ply_count: dropoffData.target,
              fitness_score: dropoffData.score,
              dropped_indices: dropoffData.dropped
            })
          });
          
          if (response.ok) {
            const data = await response.json();
            currentZones = data.zones || [];
            currentTransitions = data.transitions || [];
            // Yeni oluÅŸturulan zone'un ID'sini kaydet (bir sonraki drop-off iÃ§in kaynak olacak)
            if (data.zone && data.zone.zone_id !== undefined) {
              lastDropoffSourceZoneId = data.zone.zone_id;
              // EÄŸer kullanÄ±cÄ± plan ÅŸemada bir hedef (Ã¼st/orta/alt) seÃ§tiyse, yeni zone'u o slot'a yerleÅŸtir
              if (pendingPlanDrop && pendingPlanDrop.sourceZoneId === sourceZoneId) {
                planLayoutHints[lastDropoffSourceZoneId] = {
                  slot: pendingPlanDrop.slot,
                  col: pendingPlanDrop.targetDepth,
                  kind: pendingPlanDrop.kind || 'global',
                  anchor: pendingPlanDrop.sourceZoneId
                };
                pendingPlanDrop = null;
              }
            }
            renderZoneList();
            renderZoneDiagram();
            updateZoneSelects();
          }
        } catch (error) {
          console.error('Zone ekleme hatasÄ±:', error);
        }
      }

      async function loadZones() {
        try {
          const response = await fetch(`${API_BASE}/zones/list?session_id=${currentSessionId}`);
          const data = await response.json();
          currentZones = data.zones || [];
          currentTransitions = data.transitions || [];
          renderZoneList();
          renderZoneDiagram();
          updateZoneSelects();
        } catch (error) {
          console.error('Zone yÃ¼kleme hatasÄ±:', error);
        }
      }

      function renderZoneList() {
        zoneList.innerHTML = '';
        if (currentZones.length === 0) {
          zoneList.innerHTML = '<div class="text-slate-600 text-sm">HenÃ¼z zone oluÅŸturulmadÄ±</div>';
          return;
        }
        
        currentZones.forEach(zone => {
          const zoneDiv = document.createElement('div');
          zoneDiv.className = 'bg-white/70 backdrop-blur border border-slate-300/60 rounded-md p-3 shadow-sm';
          zoneDiv.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <span class="font-semibold text-slate-800">${zone.name}</span>
              <span class="text-xs text-slate-500">ID: ${zone.zone_id}</span>
            </div>
            <div class="text-xs text-slate-600 space-y-1">
              <div>Ply SayÄ±sÄ±: <span class="text-slate-800 font-mono">${zone.ply_count}</span></div>
              <div>Fitness: <span class="text-emerald-700 font-mono">${zone.fitness_score.toFixed(2)}</span></div>
              <div>Tip: <span class="text-slate-800">${zone.transition_type === 'drop_off' ? 'Drop-Off' : 'Merge'}</span></div>
              ${zone.source_zones.length > 0 ? `<div>Kaynak: <span class="text-slate-800">Zone ${zone.source_zones.join(', ')}</span></div>` : ''}
            </div>
          `;
          zoneList.appendChild(zoneDiv);
        });
      }

      function renderZoneDiagram() {
        // GeliÅŸmiÅŸ ÅŸematik gÃ¶rselleÅŸtirme
        if (currentZones.length === 0) {
          zoneDiagram.innerHTML = '<div class="text-slate-500 text-center py-20">Zone diyagramÄ± burada gÃ¶rÃ¼ntÃ¼lenecek</div>';
          return;
        }

        // Zone pozisyonlarÄ±nÄ± hesapla (hierarchical layout)
        const zonePositions = {};
        const zoneLevels = {}; // Her zone'un seviyesi (root = 0)
        const levelZones = {}; // Her seviyedeki zone'lar
        
        // Root zone'u bul ve seviye 0'a koy
        const rootZone = currentZones.find(z => z.zone_id === 0);
        if (rootZone) {
          zoneLevels[0] = 0;
          levelZones[0] = levelZones[0] || [];
          levelZones[0].push(rootZone);
        }
        
        // DiÄŸer zone'larÄ± seviyelere gÃ¶re yerleÅŸtir
        const processed = new Set([0]);
        let currentLevel = 1;
        
        while (processed.size < currentZones.length) {
          levelZones[currentLevel] = levelZones[currentLevel] || [];
          
          currentZones.forEach(zone => {
            if (processed.has(zone.zone_id)) return;
            
            // Bu zone'un kaynak zone'larÄ± iÅŸlenmiÅŸ mi?
            const allSourcesProcessed = zone.source_zones.every(sid => processed.has(sid));
            if (allSourcesProcessed && zone.source_zones.length > 0) {
              zoneLevels[zone.zone_id] = currentLevel;
              levelZones[currentLevel].push(zone);
              processed.add(zone.zone_id);
            }
          });
          
          if (levelZones[currentLevel].length === 0) break;
          currentLevel++;
        }
        
        // Ä°ÅŸlenmemiÅŸ zone'larÄ± son seviyeye ekle
        currentZones.forEach(zone => {
          if (!processed.has(zone.zone_id)) {
            const maxLevel = Math.max(...Object.keys(levelZones).map(Number));
            levelZones[maxLevel + 1] = levelZones[maxLevel + 1] || [];
            levelZones[maxLevel + 1].push(zone);
            zoneLevels[zone.zone_id] = maxLevel + 1;
          }
        });
        
        // PozisyonlarÄ± hesapla
        Object.keys(levelZones).forEach(level => {
          const zonesInLevel = levelZones[level];
          const levelNum = parseInt(level);
          const y = levelNum * 120 + 30;
          const totalWidth = zonesInLevel.length * 180;
          const startX = (800 - totalWidth) / 2; // Ortala
          
          zonesInLevel.forEach((zone, idx) => {
            const x = startX + idx * 180;
            zonePositions[zone.zone_id] = { x, y };
          });
        });

        // SVG container
        let html = '<div class="relative" style="min-height: 400px; overflow-x: auto;">';
        html += '<svg class="absolute" style="width: 100%; height: 100%; min-width: 800px; min-height: 400px;">';
        
        // Arrow marker tanÄ±mla
        html += `
          <defs>
            <marker id="arrowhead-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <polygon points="0 0, 10 3, 0 6" fill="#1d4ed8" />
            </marker>
            <marker id="arrowhead-purple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <polygon points="0 0, 10 3, 0 6" fill="#6d28d9" />
            </marker>
            <marker id="arrowhead-orange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
              <polygon points="0 0, 10 3, 0 6" fill="#b45309" />
            </marker>
          </defs>
        `;
        
        // GeÃ§iÅŸleri Ã§iz - FotoÄŸraftaki gibi temiz ve organize
        // Her hedef zone iÃ§in gelen Ã§izgileri grupla ve ayrÄ± tut
        const targetConnections = {}; // target_id -> array of {fromId, fromX, fromY, trans}
        
        currentTransitions.forEach((trans) => {
          const fromIds = Array.isArray(trans.from) ? trans.from : [trans.from];
          const toZone = currentZones.find(z => z.zone_id === trans.to);
          
          if (!toZone || !zonePositions[trans.to]) return;
          
          fromIds.forEach((fromId) => {
            const fromZone = currentZones.find(z => z.zone_id === fromId);
            if (!fromZone || !zonePositions[fromId]) return;
            
            if (!targetConnections[trans.to]) {
              targetConnections[trans.to] = [];
            }
            
            targetConnections[trans.to].push({
              fromId,
              fromX: zonePositions[fromId].x + 75,
              fromY: zonePositions[fromId].y + 60,
              trans
            });
          });
        });
        
        // Her hedef zone iÃ§in Ã§izgileri dÃ¼zenli Ã§iz
        Object.keys(targetConnections).forEach((targetId, targetIdx) => {
          const connections = targetConnections[targetId];
          const toZone = currentZones.find(z => z.zone_id === parseInt(targetId));
          if (!toZone || !zonePositions[toZone.zone_id]) return;
          
          const toX = zonePositions[toZone.zone_id].x + 75;
          const toY = zonePositions[toZone.zone_id].y;
          const totalConnections = connections.length;
          
          connections.forEach((conn, connIdx) => {
            const fromX = conn.fromX;
            const fromY = conn.fromY;
            const trans = conn.trans;
            
            const strokeColor = trans.type === 'merge' ? '#6d28d9' : 
                               trans.type === 'angle_drop_off' ? '#b45309' : '#1d4ed8';
            const markerId = trans.type === 'merge' ? 'arrowhead-purple' : 
                            trans.type === 'angle_drop_off' ? 'arrowhead-orange' : 'arrowhead-blue';
            
            // FotoÄŸraftaki gibi: Her Ã§izgiyi hedefe yaklaÅŸtÄ±rÄ±rken offset ver
            // Hedef zone'un sol tarafÄ±na farklÄ± yÃ¼ksekliklerde yaklaÅŸ
            const offsetY = totalConnections > 1 
              ? ((connIdx - (totalConnections - 1) / 2) * 15) // Her Ã§izgi 15px aralÄ±kla
              : 0;
            
            // Basit L-ÅŸekilli path: Yatay â†’ Dikey (fotoÄŸraftaki gibi dÃ¼z Ã§izgiler)
            // Zone'dan Ã§Ä±kÄ±ÅŸ â†’ Ara nokta (hedefin yanÄ±nda) â†’ Hedefe giriÅŸ
            const midX = toX - 30; // Hedefin 30px soluna
            const approachY = toY + offsetY; // Hedefe yaklaÅŸÄ±m yÃ¼ksekliÄŸi
            
            const pathId = `path-${targetId}-${connIdx}`;
            
            // DÃ¼z Ã§izgilerle L-ÅŸekilli path
            html += `
              <path id="${pathId}"
                    d="M ${fromX} ${fromY} L ${midX} ${fromY} L ${midX} ${approachY} L ${toX} ${approachY}" 
                    stroke="${strokeColor}" 
                    stroke-width="2.5" 
                    fill="none"
                    marker-end="url(#${markerId})"
                    class="transition-path"
                    style="animation-delay: ${targetIdx * 0.1 + connIdx * 0.05}s;"/>
            `;
          });
        });
        
        // Zone'larÄ± Ã§iz (animasyonlu)
        currentZones.forEach((zone, zoneIdx) => {
          const pos = zonePositions[zone.zone_id];
          if (!pos) return;
          
          const borderColor = zone.zone_id === 0 ? '#1d4ed8' : 
                             zone.transition_type === 'merge' ? '#6d28d9' : 
                             zone.transition_type === 'angle_drop_off' ? '#b45309' : '#1d4ed8';
          
          // Gradient tanÄ±mla (daha gÃ¼zel gÃ¶rÃ¼nÃ¼m iÃ§in)
          const gradientId = `gradient-${zone.zone_id}`;
          html += `
            <defs>
              <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:${borderColor};stop-opacity:0.16" />
                <stop offset="100%" style="stop-color:${borderColor};stop-opacity:0.03" />
              </linearGradient>
              <filter id="glow-${zone.zone_id}">
                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                <feMerge>
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
          `;
          
          html += `
            <g class="zone-group zone-hover-group" data-zone-id="${zone.zone_id}"
               style="animation: fadeInScale 0.5s ease-out ${zoneIdx * 0.1}s both;">
              <rect x="${pos.x}" y="${pos.y}" width="150" height="60" rx="8" 
                    fill="url(#${gradientId})" 
                    stroke="${borderColor}" 
                    stroke-width="2.5" 
                    class="zone-box"
                    style="transition: all 0.3s ease; cursor: pointer;"
                    filter="url(#glow-${zone.zone_id})"/>
              <text x="${pos.x + 75}" y="${pos.y + 20}" 
                    text-anchor="middle" fill="#0f172a" font-weight="700" font-size="14"
                    style="pointer-events: none; user-select: none;">
                ${zone.name}
              </text>
              <text x="${pos.x + 75}" y="${pos.y + 38}" 
                    text-anchor="middle" fill="#475569" font-size="11"
                    style="pointer-events: none; user-select: none;">
                ${zone.ply_count} ply
              </text>
              <text x="${pos.x + 75}" y="${pos.y + 55}" 
                    text-anchor="middle" fill="#047857" font-size="11" font-weight="700"
                    style="pointer-events: none; user-select: none;">
                ${zone.fitness_score.toFixed(1)}
              </text>
            </g>
          `;
        });
        
        html += '</svg></div>';
        zoneDiagram.innerHTML = html;
      }

      // Plan-view schematic (mentor sketch style): show ply totals and derivation
      function renderPlanSchematic() {
        if (!planSchematicEl) return;

        const zones = (currentZones || []).slice();
        if (!zones.length) {
          planSchematicEl.innerHTML = '<div class="h-full flex items-center justify-center text-xs text-slate-500">Åematik iÃ§in Ã¶nce root zone oluÅŸturun.</div>';
          return;
        }

        const zoneById = new Map(zones.map(z => [z.zone_id, z]));
        const allIds = new Set(zones.map(z => z.zone_id));

        // Selected source: dropdown drives highlight (master -> Root if present)
        let selectedId = null;
        if (dropoffSourceZoneSelect && dropoffSourceZoneSelect.value) {
          if (dropoffSourceZoneSelect.value === 'master') {
            selectedId = allIds.has(0) ? 0 : null;
          } else {
            const parsed = parseInt(dropoffSourceZoneSelect.value);
            selectedId = Number.isFinite(parsed) ? parsed : null;
          }
        } else {
          selectedId = allIds.has(0) ? 0 : null;
        }

        // Build adjacency from transitions
        const children = new Map(); // from -> Set(to)
        (currentTransitions || []).forEach(tr => {
          const to = tr.to;
          if (!allIds.has(to)) return;
          const froms = Array.isArray(tr.from) ? tr.from : [tr.from];
          froms.forEach(f => {
            if (!allIds.has(f)) return;
            if (!children.has(f)) children.set(f, new Set());
            children.get(f).add(to);
          });
        });

        // BFS depths from Root (0) if exists, else first zone
        const rootId = allIds.has(0) ? 0 : zones[0].zone_id;
        const depth = new Map();
        depth.set(rootId, 0);
        const q = [rootId];
        while (q.length) {
          const id = q.shift();
          const kids = children.get(id) ? Array.from(children.get(id)) : [];
          kids.forEach(k => {
            if (!depth.has(k)) {
              depth.set(k, (depth.get(id) || 0) + 1);
              q.push(k);
            }
          });
        }
        // Place any disconnected zones on depth 1+
        zones.forEach(z => {
          if (!depth.has(z.zone_id)) depth.set(z.zone_id, 1);
        });

        // Explicit column override (e.g. ÃœSTÃœNE/ALTINA -> same column as source)
        zones.forEach(z => {
          const hintedCol = planLayoutHints[z.zone_id]?.col;
          if (Number.isFinite(hintedCol)) depth.set(z.zone_id, Math.max(0, hintedCol));
        });

        const maxDepth = Math.max(...Array.from(depth.values()));
        const levelsRaw = new Map(); // d -> zoneIds[]
        zones.forEach(z => {
          const d = depth.get(z.zone_id) || 0;
          if (!levelsRaw.has(d)) levelsRaw.set(d, []);
          levelsRaw.get(d).push(z.zone_id);
        });

        // Depth-by-depth ordering so we can keep "above/below source" intuition.
        const levels = new Map(); // d -> sorted zoneIds[]
        const indexInLevel = new Map(); // zone_id -> index in its depth

        const getKindOffset = (kind) => {
          if (kind === 'above') return -1;
          if (kind === 'below') return 1;
          return 0; // 'global' or undefined
        };

        const getSlot = (id) => (planLayoutHints[id]?.slot ?? 1);
        const getKind = (id) => (planLayoutHints[id]?.kind ?? 'global');
        const getAnchor = (id) => (planLayoutHints[id]?.anchor ?? null);

        // Depth 0
        const level0 = (levelsRaw.get(0) || []).slice();
        level0.sort((a, b) => {
          const za = zoneById.get(a);
          const zb = zoneById.get(b);
          const pa = (za?.ply_count ?? 0);
          const pb = (zb?.ply_count ?? 0);
          if (pb !== pa) return pb - pa;
          return a - b;
        });
        levels.set(0, level0);
        level0.forEach((id, idx) => indexInLevel.set(id, idx));

        // Depth 1..maxDepth
        for (let d = 1; d <= maxDepth; d++) {
          const ids = (levelsRaw.get(d) || []).slice();
          ids.sort((a, b) => {
            const za = zoneById.get(a);
            const zb = zoneById.get(b);
            const pa = (za?.ply_count ?? 0);
            const pb = (zb?.ply_count ?? 0);

            // Prefer positioning relative to anchor (source zone)
            const aa = getAnchor(a);
            const ab = getAnchor(b);
            const ia = aa !== null && indexInLevel.has(aa) ? indexInLevel.get(aa) : 0;
            const ib = ab !== null && indexInLevel.has(ab) ? indexInLevel.get(ab) : 0;

            const da = ia * 10 + getKindOffset(getKind(a));
            const db = ib * 10 + getKindOffset(getKind(b));
            if (da !== db) return da - db;

            // Secondary: slot (global Ãœst/Orta/Alt)
            const sa = getSlot(a);
            const sb = getSlot(b);
            if (sa !== sb) return sa - sb;

            // Then: ply desc, id asc
            if (pb !== pa) return pb - pa;
            return a - b;
          });

          levels.set(d, ids);
          ids.forEach((id, idx) => indexInLevel.set(id, idx));
        }

        // Make zones "contiguous" like the mentor sketch:
        // - Each depth is a column slice inside the part
        // - Each depth has 3 fixed vertical slots (Ã¼st/orta/alt)
        //   so even a single child can sit above/below instead of stretching full height.
        const W = 1000;
        const H = 240;
        const pad = 16;
        const outerPad = 10;
        const innerX = outerPad + pad;
        const innerY = outerPad + pad;
        const innerW = W - (outerPad + pad) * 2;
        const innerH = H - (outerPad + pad) * 2;
        // Her zaman bir "boÅŸ kolon" daha gÃ¶ster ki kullanÄ±cÄ± drop hedefini seÃ§ebilsin
        const cols = Math.max(2, maxDepth + 2);
        const colW = innerW / cols;

        const cell = new Map(); // id -> {x,y,w,h,cx,cy,lx,rx}
        const slotH = innerH / 3;
        levels.forEach((ids, d) => {
          const x = innerX + d * colW;
          const w = colW;
          const bySlot = { 0: [], 1: [], 2: [] };
          ids.forEach((id) => {
            const s = (planLayoutHints[id]?.slot ?? 1);
            const slot = (s === 0 || s === 2) ? s : 1;
            bySlot[slot].push(id);
          });
          [0, 1, 2].forEach((slot) => {
            const arr = bySlot[slot];
            if (!arr || arr.length === 0) return;
            const perH = slotH / arr.length;
            arr.forEach((id, idx) => {
              const y = innerY + slot * slotH + idx * perH;
              const h = perH;
              cell.set(id, {
                x, y, w, h,
                cx: x + w / 2,
                cy: y + h / 2,
                lx: x,
                rx: x + w
              });
            });
          });
        });

        // SVG scaffolding: outer "part" rectangle like the sketch
        let svg = `
          <svg viewBox="0 0 ${W} ${H}" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <marker id="ps-arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto">
                <polygon points="0 0, 10 3, 0 6" fill="#0f172a" opacity="0.55" />
              </marker>
            </defs>
            <rect x="${outerPad}" y="${outerPad}" width="${W - outerPad * 2}" height="${H - outerPad * 2}" rx="10"
                  fill="rgba(255,255,255,0.15)" stroke="rgba(15,23,42,0.20)" stroke-width="2"/>
        `;

        // Draw column separators (subtle)
        for (let c = 1; c < cols; c++) {
          const x = innerX + c * colW;
          svg += `<line x1="${x}" y1="${innerY}" x2="${x}" y2="${innerY + innerH}" stroke="rgba(15,23,42,0.10)" stroke-width="1"/>`;
        }

        // Draw transitions as internal arrows (center-to-center)
        (currentTransitions || []).forEach(tr => {
          const to = tr.to;
          if (!allIds.has(to)) return;
          const toZ = zoneById.get(to);
          const toC = cell.get(to);
          if (!toC) return;
          const froms = Array.isArray(tr.from) ? tr.from : [tr.from];
          froms.forEach((f, fi) => {
            if (!allIds.has(f)) return;
            const fromZ = zoneById.get(f);
            const fromC = cell.get(f);
            if (!fromC || !fromZ) return;

            // Center-to-center (requested)
            const x1 = fromC.cx;
            const y1 = fromC.cy;
            const x2 = toC.cx;
            const y2 = toC.cy;

            // slight offset to reduce overlap when multiple edges converge
            const off = (fi - (froms.length - 1) / 2) * 6;
            const sy1 = y1 + off;
            const sy2 = y2 + off;

            const label = `${fromZ.ply_count}â†’${toZ?.ply_count ?? ''}`;
            const mx = (x1 + x2) / 2;
            const my = (sy1 + sy2) / 2;

            // Mild curve for readability (still center-to-center)
            const cx = mx;
            const cy = my - 18; // lift label/curve slightly

            svg += `
              <path d="M ${x1} ${sy1} Q ${cx} ${cy} ${x2} ${sy2}"
                    stroke="rgba(15,23,42,0.45)" stroke-width="2"
                    fill="none"
                    marker-end="url(#ps-arrow)"/>
              <g opacity="0.9">
                <rect x="${mx - 18}" y="${my - 10}" width="36" height="16" rx="6"
                      fill="rgba(255,255,255,0.75)" stroke="rgba(15,23,42,0.15)"/>
                <text x="${mx}" y="${my + 2}" text-anchor="middle"
                      font-family="JetBrains Mono, ui-monospace" font-size="10"
                      fill="#0f172a" opacity="0.75">${label}</text>
              </g>
            `;
          });
        });

        // Draw contiguous zone cells (touching, like regions)
        zones.forEach(z => {
          const c = cell.get(z.zone_id);
          if (!c) return;
          const isSelected = selectedId !== null && z.zone_id === selectedId;
          const stroke = isSelected ? '#e11d48' : 'rgba(15,23,42,0.35)';
          const strokeW = isSelected ? 3 : 2;
          const seqBtnFill = isSelected ? 'rgba(225,29,72,0.10)' : 'rgba(15,23,42,0.06)';
          const seqBtnStroke = isSelected ? 'rgba(225,29,72,0.45)' : 'rgba(15,23,42,0.16)';

          svg += `
            <g data-zone-id="${z.zone_id}" style="cursor:pointer">
              <rect x="${c.x}" y="${c.y}" width="${c.w}" height="${c.h}"
                    rx="8"
                    fill="rgba(255,255,255,0.72)"
                    stroke="${stroke}" stroke-width="${strokeW}"/>

              <text x="${c.x + 12}" y="${c.y + 18}"
                    font-family="Inter, system-ui, sans-serif" font-size="12"
                    fill="#0f172a" opacity="0.85">${z.name}</text>
              <text x="${c.x + 12}" y="${c.y + 42}"
                    font-family="JetBrains Mono, ui-monospace" font-size="20"
                    fill="#0f172a" font-weight="700">${z.ply_count}</text>

              <!-- Small in-box button to show stacking sequence (no hover needed) -->
              <g data-seq-btn="1" data-zid="${z.zone_id}" style="cursor:pointer">
                <rect x="${c.x + 10}" y="${c.y + 6}" width="40" height="18" rx="9"
                      fill="${seqBtnFill}" stroke="${seqBtnStroke}" stroke-width="1"/>
                <text x="${c.x + 30}" y="${c.y + 19}" text-anchor="middle"
                      font-family="JetBrains Mono, ui-monospace" font-size="10"
                      fill="rgba(15,23,42,0.75)" style="pointer-events:none; user-select:none;">DIZ</text>
              </g>
            </g>
          `;
        });

        // Drop hedefi seÃ§imi (EN ÃœSTTE Ã§izilsin ki tÄ±klanabilir olsun):
        // - Hedef kolonda (bir sonraki kolon) 3 slot (Ã¼st/orta/alt)
        // - ÃœSTÃœNE/ALTINA: SAÄA deÄŸil, aynÄ± kolonda Ã¼st/alt yerleÅŸim
        if (selectedId !== null && depth.has(selectedId)) {
          const sd = depth.get(selectedId) || 0;
          const targetDepth = sd + 1;
          const srcCell = cell.get(selectedId);
          if (srcCell && targetDepth < cols) {
            const tx = innerX + targetDepth * colW;

            // Hedef kolonunda 3 slotâ€™u (arka plan) gÃ¶ster (etiketsiz, tÄ±klanabilir)
            [0, 1, 2].forEach((slot) => {
              const y = innerY + slot * slotH;
              const isActive =
                pendingPlanDrop &&
                pendingPlanDrop.sourceZoneId === selectedId &&
                pendingPlanDrop.targetDepth === targetDepth &&
                pendingPlanDrop.slot === slot &&
                (pendingPlanDrop.kind || 'global') === 'global';
              svg += `
                <g data-drop-target="1" data-kind="global" data-target-depth="${targetDepth}" data-slot="${slot}" style="cursor:pointer">
                  <rect x="${tx}" y="${y}" width="${colW}" height="${slotH}"
                        fill="${isActive ? 'rgba(225,29,72,0.08)' : 'rgba(15,23,42,0.015)'}"
                        stroke="${isActive ? 'rgba(225,29,72,0.45)' : 'rgba(15,23,42,0.06)'}"
                        stroke-width="${isActive ? 2 : 1}"
                        stroke-dasharray="4 4"/>
                </g>
              `;
            });

            // SeÃ§ili kutunun Ã¼stÃ¼ne/altÄ±na hÄ±zlÄ± hedef butonlarÄ±
            // NOT: targetDepth = sd (aynÄ± kolon) olarak kaydedilir.
            const btnW = Math.min(92, colW - 18);
            const btnH = 18;
            const bx = Math.min(srcCell.x + srcCell.w - btnW - 10, W - outerPad - btnW - 10);
            const drawBtn = (kind, by, slot, text) => {
              const isActive =
                pendingPlanDrop &&
                pendingPlanDrop.sourceZoneId === selectedId &&
                pendingPlanDrop.targetDepth === sd &&
                pendingPlanDrop.slot === slot &&
                (pendingPlanDrop.kind || 'global') === kind;
              svg += `
                <g data-drop-target="1" data-kind="${kind}" data-target-depth="${sd}" data-slot="${slot}" style="cursor:pointer">
                  <rect x="${bx}" y="${by}" width="${btnW}" height="${btnH}" rx="8"
                        fill="${isActive ? 'rgba(225,29,72,0.16)' : 'rgba(255,255,255,0.70)'}"
                        stroke="${isActive ? 'rgba(225,29,72,0.70)' : 'rgba(15,23,42,0.18)'}"
                        stroke-width="${isActive ? 2 : 1}"/>
                  <text x="${bx + 10}" y="${by + 12}"
                        font-family="Inter, system-ui, sans-serif" font-size="11"
                        fill="rgba(15,23,42,0.75)">${text}</text>
                </g>
              `;
            };
            // ÃœstÃ¼ne / AltÄ±na: yeni zone aynÄ± kolonda (sd) ama Ã¼st slot veya alt slot'a gider
            const topBy = Math.max(innerY + 6, Math.min(srcCell.y + 6, innerY + innerH - btnH - 6));
            const botBy = Math.max(innerY + 6, Math.min(srcCell.y + srcCell.h - btnH - 6, innerY + innerH - btnH - 6));
            drawBtn('above', topBy, 0, 'ÃœSTÃœNE');
            drawBtn('below', botBy, 2, 'ALTINA');
          }
        }

        svg += '</svg>';
        planSchematicEl.innerHTML = svg;

        // Hover tooltip for zone sequence (accordion-like)
        let tooltip = planSchematicEl.querySelector('#plan-schematic-tooltip');
        if (!tooltip) {
          tooltip = document.createElement('div');
          tooltip.id = 'plan-schematic-tooltip';
          tooltip.className = 'hidden absolute z-20 w-[860px] max-w-[96vw]';
          tooltip.style.pointerEvents = 'none';
          planSchematicEl.appendChild(tooltip);
        }

        const angleClass = (a) => {
          if (a === 0) return 'bg-emerald-500';
          if (a === 90) return 'bg-sky-500';
          if (a === 45) return 'bg-rose-500';
          if (a === -45) return 'bg-amber-500';
          return 'bg-slate-500';
        };

        const buildSeqPreview = (seq) => {
          // Tooltip yatay kaydÄ±rmalÄ± olduÄŸu iÃ§in mÃ¼mkÃ¼n olduÄŸunca tam gÃ¶ster.
          // Sadece aÅŸÄ±rÄ± uzun dizilimlerde (Ã¶rn. yÃ¼zlerce) kÄ±salt.
          const maxShow = 500;
          const safe = Array.isArray(seq) ? seq : [];
          if (safe.length <= maxShow) return safe;
          const head = safe.slice(0, 80);
          const tail = safe.slice(-60);
          return [...head, 'â€¦', ...tail];
        };

        const showTooltip = (zoneId) => {
          const z = zoneById.get(zoneId);
          if (!z || !Array.isArray(z.sequence)) return;

          // counts
          const counts = { 0: 0, 90: 0, 45: 0, '-45': 0 };
          z.sequence.forEach(a => {
            if (a === 0) counts[0] += 1;
            else if (a === 90) counts[90] += 1;
            else if (a === 45) counts[45] += 1;
            else if (a === -45) counts['-45'] += 1;
          });

          const nTotal = z.sequence.length;
          const isOdd = nTotal % 2 === 1;
          const mid = Math.floor(nTotal / 2);
          const axisText = isOdd ? `eks:${mid}` : `eks:${mid - 1}|${mid}`;

          const preview = buildSeqPreview(z.sequence);
          // If preview is shortened, axis marker may not be visually present; show axisText anyway.
          let chips = '';
          const addAxisMarkerBetween = () =>
            `<span class="inline-flex items-center justify-center w-[4px] h-7 bg-amber-500/90 rounded-sm shadow-[0_0_6px_rgba(245,158,11,0.35)] mx-1" title="Simetri ekseni"></span>`;

          for (let i = 0; i < preview.length; i++) {
            const a = preview[i];
            if (a === 'â€¦') {
              chips += `<span class="px-2 py-1 rounded-md bg-slate-200 text-slate-700 text-[10px] font-mono">â€¦</span>`;
              continue;
            }
            const ang = Number(a);
            const cls = angleClass(ang);

            // Even: axis is between two middle plies -> add marker when we reach mid index
            // Only works when we are rendering full sequence (no ellipsis). For shortened preview, marker might be absent.
            if (!isOdd && preview.length === nTotal && i === mid) {
              chips += addAxisMarkerBetween();
            }

            // Odd: axis is on the middle ply -> overlay marker on that chip (only if not shortened)
            const isAxisOnThis = isOdd && preview.length === nTotal && i === mid;
            chips += `
              <span class="relative inline-flex items-center justify-center w-7 h-7 rounded-sm ${cls} text-[9px] font-mono font-semibold text-white shadow-sm">
                ${ang}Â°
                ${isAxisOnThis ? `<span class="absolute left-1/2 top-[-3px] w-[3px] h-[32px] bg-amber-500/90 rounded-sm shadow-[0_0_6px_rgba(245,158,11,0.35)]" style="transform: translateX(-50%);"></span>` : ``}
              </span>
            `;
          }

          tooltip.innerHTML = `
            <div class="bg-white/90 backdrop-blur border border-slate-300/70 rounded-xl shadow-xl overflow-hidden">
              <div class="px-3 py-2 border-b border-slate-200 flex items-center justify-between">
                <div class="text-sm font-semibold text-slate-900">${z.name} â€” <span class="font-mono">${z.ply_count}</span> ply</div>
                <div class="text-[11px] text-slate-600 font-mono">0:${counts[0]}  90:${counts[90]}  45:${counts[45]}  -45:${counts['-45']}  â€¢  ${axisText}</div>
              </div>
              <div class="px-3 py-2">
                <div class="text-[11px] text-slate-600 mb-2">Dizilim (hover ile aÃ§Ä±lÄ±r/kapanÄ±r):</div>
                <div class="flex flex-nowrap gap-1 overflow-x-auto overflow-y-hidden pb-1 whitespace-nowrap">
                  ${chips}
                </div>
              </div>
            </div>
          `;

          tooltip.classList.remove('hidden');

          // position relative to zone rect, prefer above
          const g = planSchematicEl.querySelector(`[data-zone-id="${zoneId}"]`);
          const rect = planSchematicEl.getBoundingClientRect();
          const svgEl = planSchematicEl.querySelector('svg');
          if (!g || !svgEl) return;

          // read cell bbox from rect element inside g
          const r = g.querySelector('rect');
          if (!r) return;
          const x = Number(r.getAttribute('x')) || 0;
          const y = Number(r.getAttribute('y')) || 0;
          const w = Number(r.getAttribute('width')) || 0;
          const h = Number(r.getAttribute('height')) || 0;

          const viewBox = svgEl.viewBox.baseVal;
          const sx = rect.width / (viewBox.width || 1000);
          const sy = rect.height / (viewBox.height || 240);
          const px = x * sx;
          const py = y * sy;
          const pw = w * sx;
          const ph = h * sy;

          // compute tooltip size after render
          const ttW = tooltip.offsetWidth || 860;
          const ttH = tooltip.offsetHeight || 160;
          // Prefer side placement so we don't visually cover ÃœSTÃœNE/ALTINA buttons
          let left = px - ttW - 12; // left side
          let top = py + ph / 2 - ttH / 2; // vertically centered
          const fitsLeft = left >= 8;
          const fitsTop = top >= 8 && (top + ttH) <= (rect.height - 8);
          if (!(fitsLeft && fitsTop)) {
            // try right side
            const rightLeft = px + pw + 12;
            const fitsRight = (rightLeft + ttW) <= (rect.width - 8);
            if (fitsRight && fitsTop) {
              left = rightLeft;
            } else {
              // fallback: above/below centered
              left = px + pw / 2 - ttW / 2;
              left = Math.max(8, Math.min(left, rect.width - ttW - 8));
              top = py - ttH - 10; // above
              if (top < 8) top = py + ph + 10; // below fallback
              top = Math.max(8, Math.min(top, rect.height - ttH - 8));
            }
          }

          tooltip.style.left = `${left}px`;
          tooltip.style.top = `${top}px`;
        };

        const forceHideTooltip = () => {
          tooltip.classList.add('hidden');
        };

        const hideTooltip = () => {
          // If user pinned it via DIZ button, don't auto-hide
          if (planPinnedTooltipZoneId !== null) return;
          forceHideTooltip();
        };

        // Click-to-select source zone
        planSchematicEl.querySelectorAll('[data-zone-id]').forEach(el => {
          el.addEventListener('click', () => {
            const zid = el.getAttribute('data-zone-id');
            if (!dropoffSourceZoneSelect) return;
            planPinnedTooltipZoneId = null;
            forceHideTooltip();
            dropoffSourceZoneSelect.value = String(zid);
            pendingPlanDrop = null; // kaynak deÄŸiÅŸince hedef seÃ§imi sÄ±fÄ±rla
            dropoffSourceZoneSelect.dispatchEvent(new Event('change'));
          });

          // Hover: show sequence
          el.addEventListener('mouseenter', () => {
            const zid = parseInt(el.getAttribute('data-zone-id'));
            if (!Number.isFinite(zid)) return;
            // SeÃ§ili zone Ã¼zerinde tooltip aÃ§ma: hedef butonlarÄ±nÄ± kapatabiliyor.
            if (selectedId !== null && zid === selectedId) return;
            showTooltip(zid);
          });
          el.addEventListener('mouseleave', hideTooltip);
        });

        // Click-to-toggle sequence panel (DIZ)
        planSchematicEl.querySelectorAll('[data-seq-btn="1"]').forEach(el => {
          el.addEventListener('click', (e) => {
            e.stopPropagation();
            const zid = parseInt(el.getAttribute('data-zid'));
            if (!Number.isFinite(zid)) return;
            if (planPinnedTooltipZoneId === zid) {
              planPinnedTooltipZoneId = null;
              forceHideTooltip();
              return;
            }
            planPinnedTooltipZoneId = zid;
            showTooltip(zid);
          });
        });

        // Click-to-select drop target slot (Ã¼st/orta/alt)
        planSchematicEl.querySelectorAll('[data-drop-target="1"]').forEach(el => {
          el.addEventListener('click', (e) => {
            e.stopPropagation();
            if (selectedId === null) return;
            const td = parseInt(el.getAttribute('data-target-depth'));
            const slot = parseInt(el.getAttribute('data-slot'));
            const kind = el.getAttribute('data-kind') || 'global';
            if (!Number.isFinite(td) || !Number.isFinite(slot)) return;
            pendingPlanDrop = { sourceZoneId: selectedId, targetDepth: td, slot, kind };
            renderPlanSchematic();
          });
        });

        // Hide tooltip when leaving the whole panel
        planSchematicEl.addEventListener('mouseleave', hideTooltip);

        // If user pinned a tooltip, restore it after rerender
        if (planPinnedTooltipZoneId !== null && zoneById.has(planPinnedTooltipZoneId)) {
          showTooltip(planPinnedTooltipZoneId);
        }
      }

      function updateZoneSelects() {
        // Drop-off kaynak zone select (ana drop-off paneli)
        if (dropoffSourceZoneSelect) {
          dropoffSourceZoneSelect.innerHTML = '<option value="master">Mevcut Master (Optimizasyon Sonucu)</option>';
          (currentZones || []).forEach(zone => {
            const option = document.createElement('option');
            option.value = zone.zone_id.toString();
            option.textContent = `${zone.name} (${zone.ply_count} ply)`;
            dropoffSourceZoneSelect.appendChild(option);
          });

          // VarsayÄ±lan: son drop-off kaynaÄŸÄ± varsa onu seÃ§, yoksa Root varsa Root
          const hasLast = lastDropoffSourceZoneId !== null && (currentZones || []).some(z => z.zone_id === lastDropoffSourceZoneId);
          if (hasLast) {
            dropoffSourceZoneSelect.value = String(lastDropoffSourceZoneId);
          } else if ((currentZones || []).some(z => z.zone_id === 0)) {
            dropoffSourceZoneSelect.value = '0';
          } else {
            dropoffSourceZoneSelect.value = 'master';
          }
        }
        
        // Merge zones select
        mergeZonesSelect.innerHTML = '';
        currentZones.forEach(zone => {
          const option = document.createElement('option');
          option.value = zone.zone_id.toString(); // String olarak set et
          option.textContent = `${zone.name} (${zone.ply_count} ply)`;
          mergeZonesSelect.appendChild(option);
        });

        // Refresh plan schematic (source selection + photo-like view)
        renderPlanSchematic();
      }

      // Initialize root zone
      initRootZoneBtn.addEventListener('click', async () => {
        if (!currentMasterSequence) {
          alert('LÃ¼tfen Ã¶nce bir optimizasyon Ã§alÄ±ÅŸtÄ±rÄ±n.');
          return;
        }
        
        try {
          initRootZoneBtn.disabled = true;
          initRootZoneBtn.textContent = 'BaÅŸlatÄ±lÄ±yor...';
          
          const response = await fetch(`${API_BASE}/zones/init_root`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              session_id: currentSessionId,
              master_sequence: currentMasterSequence,
              ply_counts: currentPlyCounts
            })
          });
          
          if (!response.ok) throw new Error('Root zone baÅŸlatÄ±lamadÄ±');
          
          const data = await response.json();
          currentZones = data.all_zones || [];
          currentTransitions = data.transitions || [];
          
          zoneManagementSection.classList.remove('hidden');
          renderZoneList();
          renderZoneDiagram();
          updateZoneSelects();
          
          initRootZoneBtn.textContent = 'Root Zone BaÅŸlatÄ±ldÄ± âœ“';
        } catch (error) {
          alert('Hata: ' + error.message);
          initRootZoneBtn.disabled = false;
          initRootZoneBtn.textContent = 'Root Zone\'u BaÅŸlat';
        }
      });

      // Create zone from merge
      createZoneMergeBtn.addEventListener('click', async () => {
        const selectedZones = Array.from(mergeZonesSelect.selectedOptions).map(opt => parseInt(opt.value));
        
        if (selectedZones.length < 2) {
          alert('LÃ¼tfen en az 2 zone seÃ§in.');
          return;
        }
        
        try {
          createZoneMergeBtn.disabled = true;
          createZoneMergeBtn.textContent = 'BirleÅŸtiriliyor...';
          
          const response = await fetch(`${API_BASE}/zones/create_from_merge`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              session_id: currentSessionId,
              source_zone_ids: selectedZones
            })
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Zone birleÅŸtirilemedi');
          }
          
          const data = await response.json();
          
          // Zone'larÄ± gÃ¼ncelle
          if (data.zones && Array.isArray(data.zones)) {
            currentZones = data.zones;
          }
          if (data.transitions && Array.isArray(data.transitions)) {
            currentTransitions = data.transitions;
          }
          
          // ÅemayÄ± gÃ¼ncelle
          renderZoneList();
          renderZoneDiagram();
          updateZoneSelects();
          
          // BaÅŸarÄ± mesajÄ±
          const newZone = data.zone;
          if (newZone) {
            const sourceNames = selectedZones.map(zid => zid === 0 ? 'Root' : `Zone ${zid}`).join(' + ');
            runMetaEl.textContent = `Merge Zone ${newZone.zone_id} oluÅŸturuldu: ${sourceNames} â†’ Zone ${newZone.zone_id} (${newZone.ply_count} ply, ${newZone.fitness_score.toFixed(2)} skor)`;
          }
          
          mergeZonesSelect.selectedIndex = -1;
          createZoneMergeBtn.disabled = false;
          createZoneMergeBtn.textContent = 'BirleÅŸtirme ile Zone OluÅŸtur';
        } catch (error) {
          alert('Hata: ' + error.message);
          createZoneMergeBtn.disabled = false;
          createZoneMergeBtn.textContent = 'BirleÅŸtirme ile Zone OluÅŸtur';
        }
      });

      // UI Demo Mode: load mock results without waiting optimization
      (function initDemoMode() {
        try {
          const params = new URLSearchParams(window.location.search);
          if (!params.has('demo')) return;
          if (params.get('demo') !== '1') return;

          // Show results instantly
          if (emptyState) emptyState.classList.add('hidden');
          if (resultsSection) resultsSection.classList.remove('hidden');
          runMetaEl.textContent = 'Demo Mode (No optimization run)';

          // Simple symmetric mock master sequence (36 plies)
          const master = [
            45, 0, -45, 90, 0, 45, -45, 90, 0, 45, -45, 0, 90, 45, 0, -45, 90, 0,
            0, 90, -45, 0, 45, 90, 0, -45, 45, 90, 0, -45, 45, 0, 90, -45, 0, 45
          ];
          const demoData = {
            fitness_score: 96.2,
            max_score: 100,
            stats: { plies: master.length, population_size: 120, generations: 600, duration_seconds: 0.0 },
            master_sequence: master,
            drop_off_results: [],
            penalties: {
              R1: { weight: 20, score: 20, penalty: 0, reason: '' },
              R2: { weight: 12, score: 12, penalty: 0, reason: '' },
              R3: { weight: 13, score: 12.2, penalty: 0.8, reason: 'Demo: kÃ¼Ã§Ã¼k yÃ¼zde sapmasÄ±' },
              R4: { weight: 12, score: 12, penalty: 0, reason: '' },
              R5: { weight: 8, score: 7.6, penalty: 0.4, reason: 'Demo: daÄŸÄ±lÄ±m iyileÅŸtirilebilir' },
              R6: { weight: 21, score: 21, penalty: 0, reason: '' },
              R7: { weight: 7, score: 7, penalty: 0, reason: '' },
              R8: { weight: 7, score: 6.4, penalty: 0.6, reason: 'Demo: lateral bending sÄ±nÄ±rÄ±na yakÄ±n' },
            },
            history: []
          };

          // Update globals so drop-off can be tested without waiting
          currentMasterSequence = [...demoData.master_sequence];
          originalMasterSequence = [...demoData.master_sequence];
          currentPlyCounts = { 0: 0, 90: 0, 45: 0, '-45': 0 };
          demoData.master_sequence.forEach(a => {
            if (a === 0) currentPlyCounts[0] += 1;
            else if (a === 90) currentPlyCounts[90] += 1;
            else if (a === 45) currentPlyCounts[45] += 1;
            else if (a === -45) currentPlyCounts['-45'] += 1;
          });
          if (currentPlyCountEl) currentPlyCountEl.textContent = currentMasterSequence.length;
          dropOffResults = [];

          // Render UI
          const fitnessPercentage = 100;
          fitnessScoreEl.textContent = `${demoData.fitness_score.toFixed(2)} / ${demoData.max_score.toFixed(2)}`;
          fitnessScoreEl.className = `text-3xl font-bold ${demoData.fitness_score >= 90 ? 'text-emerald-700' : demoData.fitness_score >= 70 ? 'text-amber-700' : 'text-rose-700'}`;
          fitnessHintEl.innerHTML = `<span class="text-slate-500">ğŸ’¡</span> Demo veri yÃ¼klendi.`;
          symmetryPenaltyEl.textContent = `20.00 / 20.00`;
          symmetryPenaltyEl.className = `text-2xl font-mono mt-2 text-emerald-700`;
          balanceScoreEl.textContent = `12.00 / 12.00`;
          balanceScoreEl.className = `text-2xl font-mono mt-2 text-emerald-700`;
          statsMetaEl.textContent = `${demoData.stats.plies} ply â€¢ pop ${demoData.stats.population_size} â€¢ ${demoData.stats.generations} generations`;

          renderSummary(demoData);
          renderPenalties(demoData.penalties || {});
          renderLaminateMap(demoData.master_sequence || [], []);
        } catch (e) {
          console.warn('Demo mode failed:', e);
        }
      })();
    </script>
  </body>
</html>

